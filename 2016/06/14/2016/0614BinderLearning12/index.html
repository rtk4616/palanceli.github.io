<!doctype html>



  


<html class="theme-next pisces use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  

  

  

  

  

  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Binder学习笔记," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta name="description" content="binder_open(&amp;#x2026;)&amp;#x90FD;&amp;#x5E72;&amp;#x4E86;&amp;#x4EC0;&amp;#x4E48;&amp;#xFF1F;&amp;#x5728;&amp;#x56DE;&amp;#x7B54;binder_transaction(&amp;#x2026;)&amp;#x4E4B;&amp;#x524D;&amp;#xFF0C;&amp;#x8FD8;&amp;#x6709;&amp;#x4E00;&amp;#x4E9B;&amp;#x57FA;&amp;#x7840;&amp;#x8BBE">
<meta property="og:type" content="article">
<meta property="og:title" content="Binder学习笔记（十二）—— binder_transaction(...)都干了什么？">
<meta property="og:url" content="http://palanceli.github.io/2016/06/14/2016/0614BinderLearning12/index.html">
<meta property="og:site_name" content="Palance's Blog">
<meta property="og:description" content="binder_open(&amp;#x2026;)&amp;#x90FD;&amp;#x5E72;&amp;#x4E86;&amp;#x4EC0;&amp;#x4E48;&amp;#xFF1F;&amp;#x5728;&amp;#x56DE;&amp;#x7B54;binder_transaction(&amp;#x2026;)&amp;#x4E4B;&amp;#x524D;&amp;#xFF0C;&amp;#x8FD8;&amp;#x6709;&amp;#x4E00;&amp;#x4E9B;&amp;#x57FA;&amp;#x7840;&amp;#x8BBE">
<meta property="og:image" content="http://palanceli.github.io/2016/06/14/2016/0614BinderLearning12/img04.png">
<meta property="og:image" content="http://palanceli.github.io/2016/06/14/2016/0614BinderLearning12/img01.png">
<meta property="og:image" content="http://palanceli.github.io/2016/06/14/2016/0614BinderLearning12/img02.png">
<meta property="og:image" content="http://palanceli.github.io/2016/06/14/2016/0614BinderLearning12/img05.png">
<meta property="og:image" content="http://palanceli.github.io/2016/06/14/2016/0614BinderLearning12/img06.png">
<meta property="og:image" content="http://palanceli.github.io/2016/06/14/2016/0614BinderLearning12/img04.png">
<meta property="og:image" content="http://palanceli.github.io/2016/06/14/2016/0614BinderLearning12/img07.png">
<meta property="og:image" content="http://palanceli.github.io/2016/06/14/2016/0614BinderLearning12/img08.png">
<meta property="og:image" content="http://palanceli.github.io/2016/06/14/2016/0614BinderLearning12/img09.png">
<meta property="og:image" content="http://palanceli.github.io/2016/06/14/2016/0614BinderLearning12/img10.png">
<meta property="og:image" content="https://palanceli.github.io/2016/05/11/2016/0514BinderLearning6/img02.png">
<meta property="og:image" content="http://palanceli.github.io/2016/06/14/2016/0614BinderLearning12/img11.png">
<meta property="og:image" content="http://palanceli.github.io/2016/06/14/2016/0614BinderLearning12/img12.png">
<meta property="og:image" content="http://palanceli.github.io/2016/06/14/2016/0614BinderLearning12/img13.png">
<meta property="og:image" content="http://palanceli.github.io/2016/06/14/2016/0614BinderLearning12/img14.png">
<meta property="og:updated_time" content="2017-01-29T15:19:18.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Binder学习笔记（十二）—— binder_transaction(...)都干了什么？">
<meta name="twitter:description" content="binder_open(&amp;#x2026;)&amp;#x90FD;&amp;#x5E72;&amp;#x4E86;&amp;#x4EC0;&amp;#x4E48;&amp;#xFF1F;&amp;#x5728;&amp;#x56DE;&amp;#x7B54;binder_transaction(&amp;#x2026;)&amp;#x4E4B;&amp;#x524D;&amp;#xFF0C;&amp;#x8FD8;&amp;#x6709;&amp;#x4E00;&amp;#x4E9B;&amp;#x57FA;&amp;#x7840;&amp;#x8BBE">
<meta name="twitter:image" content="http://palanceli.github.io/2016/06/14/2016/0614BinderLearning12/img04.png">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: '博主'
    }
  };
</script>




  <link rel="canonical" href="http://palanceli.github.io/2016/06/14/2016/0614BinderLearning12/"/>

  <title> Binder学习笔记（十二）—— binder_transaction(...)都干了什么？ | Palance's Blog </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  



  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?e9c9a05f15583e8039e36cfe85103e96";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>








  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Palance's Blog</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                Binder学习笔记（十二）—— binder_transaction(...)都干了什么？
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-06-14T00:20:23+08:00" content="2016-06-14">
              2016-06-14
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Android学习笔记/" itemprop="url" rel="index">
                    <span itemprop="name">Android学习笔记</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/06/14/2016/0614BinderLearning12/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/06/14/2016/0614BinderLearning12/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="binder-open-&#x2026;-&#x90FD;&#x5E72;&#x4E86;&#x4EC0;&#x4E48;&#xFF1F;"><a href="#binder-open-&#x2026;-&#x90FD;&#x5E72;&#x4E86;&#x4EC0;&#x4E48;&#xFF1F;" class="headerlink" title="binder_open(&#x2026;)&#x90FD;&#x5E72;&#x4E86;&#x4EC0;&#x4E48;&#xFF1F;"></a>binder_open(&#x2026;)&#x90FD;&#x5E72;&#x4E86;&#x4EC0;&#x4E48;&#xFF1F;</h1><p>&#x5728;&#x56DE;&#x7B54;binder_transaction(&#x2026;)&#x4E4B;&#x524D;&#xFF0C;&#x8FD8;&#x6709;&#x4E00;&#x4E9B;&#x57FA;&#x7840;&#x8BBE;&#x65BD;&#x8981;&#x53BB;&#x63A2;&#x7A76;&#xFF0C;&#x6BD4;&#x5982;binder_open(&#x2026;)&#xFF0C;binder_mmap(&#x2026;)&#xFF0C;&#x8FD9;&#x4E9B;&#x8C03;&#x7528;&#x662F;&#x5728;&#x6253;&#x5F00;&#x8BBE;&#x5907;&#x6587;&#x4EF6;/dev/binder&#x4E4B;&#x540E;&#x5FC5;&#x987B;&#x5B8C;&#x6210;&#x7684;&#x7A0B;&#x5F0F;&#x5316;&#x64CD;&#x4F5C;&#xFF0C;&#x800C;&#x5728;&#x5B83;&#x4EEC;&#x5185;&#x90E8;&#x9700;&#x8981;&#x505A;&#x4E00;&#x4E9B;&#x6570;&#x636E;&#x7ED3;&#x6784;&#x7684;&#x51C6;&#x5907;&#x3002;&#x9996;&#x5148;&#x6765;&#x770B;binder_open(&#x2026;)<br><a id="more"></a><br>kernel/drivers/staging/android/binder.c:2979<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">binder_open</span><span class="params">(<span class="keyword">struct</span> inode *nodp, <span class="keyword">struct</span> file *filp)</span></span></div><div class="line">{</div><div class="line">    <span class="keyword">struct</span> binder_proc *proc;</div><div class="line">    ......</div><div class="line">    proc = kzalloc(<span class="keyword">sizeof</span>(*proc), GFP_KERNEL); <span class="comment">// &#x521B;&#x5EFA;binder_proc&#x7ED3;&#x6784;&#x4F53;</span></div><div class="line">    ......</div><div class="line">    get_task_struct(current);</div><div class="line">    proc-&gt;tsk = current;</div><div class="line">    INIT_LIST_HEAD(&amp;proc-&gt;todo);  <span class="comment">// &#x521D;&#x59CB;&#x5316;&#x94FE;&#x8868;&#x5934;</span></div><div class="line">    init_waitqueue_head(&amp;proc-&gt;wait);   </div><div class="line">    proc-&gt;default_priority = task_nice(current);</div><div class="line"></div><div class="line">    ......</div><div class="line">    <span class="comment">// &#x5C06;proc_node&#x4E32;&#x5165;&#x5168;&#x5C40;&#x94FE;&#x8868;binder_procs&#x4E2D;</span></div><div class="line">    hlist_add_head(&amp;proc-&gt;proc_node, &amp;binder_procs); </div><div class="line">    proc-&gt;pid = current-&gt;group_leader-&gt;pid;</div><div class="line">    INIT_LIST_HEAD(&amp;proc-&gt;delivered_death);</div><div class="line">    filp-&gt;private_data = proc;</div><div class="line"></div><div class="line">    ......</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">}</div></pre></td></tr></table></figure></p>
<p>binder_open(&#x2026;)&#x751F;&#x6210;&#x5E76;&#x521D;&#x59CB;&#x5316;binder_proc&#x7ED3;&#x6784;&#x4F53;&#x5982;&#x4E0B;&#xFF1A;<br><img src="/2016/06/14/2016/0614BinderLearning12/img04.png" alt="binder_open(...)&#x521D;&#x59CB;&#x5316;&#x7684;binder_proc&#x7ED3;&#x6784;&#x4F53;"></p>
<h2 id="struct-binder-proc"><a href="#struct-binder-proc" class="headerlink" title="struct binder_proc"></a>struct binder_proc</h2><p>struct binder_proc&#x63CF;&#x8FF0;&#x4E00;&#x4E2A;&#x201C;&#x6B63;&#x5728;&#x4F7F;&#x7528;Binder&#x8FDB;&#x7A0B;&#x95F4;&#x901A;&#x4FE1;&#x673A;&#x5236;&#x201D;&#x7684;&#x8FDB;&#x7A0B;&#xFF0C;&#x5B83;&#x7684;&#x5B9A;&#x4E49;&#x53C2;&#x89C1;kernel/goldfish/drivers/staging/android/binder.c:286<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> binder_proc {</div><div class="line">    <span class="comment">// &#x8FDB;&#x7A0B;&#x6253;&#x5F00;&#x8BBE;&#x5907;&#x6587;&#x4EF6;/dev/binder&#x65F6;&#xFF0C;Binder&#x9A71;&#x52A8;&#x4F1A;&#x4E3A;&#x5B83;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;binder_proc&#x7ED3;&#x6784;&#x4F53;&#xFF0C;&#x5E76;&#x5C06;&#x5B83;</span></div><div class="line">    <span class="comment">// &#x4FDD;&#x5B58;&#x5728;&#x5168;&#x5C40;hash&#x5217;&#x8868;&#x4E2D;&#xFF0C;proc_node&#x662F;&#x8BE5;hash&#x5217;&#x8868;&#x7684;&#x8282;&#x70B9;&#x3002;</span></div><div class="line">    <span class="keyword">struct</span> hlist_node proc_node;</div><div class="line"></div><div class="line">    <span class="comment">// &#x6BCF;&#x4E2A;&#x4F7F;&#x7528;&#x4E86;Binder&#x673A;&#x5236;&#x7684;&#x8FDB;&#x7A0B;&#x90FD;&#x6709;&#x4E00;&#x4E2A;Binder&#x7EBF;&#x7A0B;&#x6C60;&#xFF0C;&#x7528;&#x6765;&#x5904;&#x7406;&#x8FDB;&#x7A0B;&#x95F4;&#x901A;&#x4FE1;&#x8BF7;&#x6C42;&#x3002;threads&#x4EE5;</span></div><div class="line">    <span class="comment">// &#x7EBF;&#x7A0B;ID&#x4F5C;&#x4E3A;key&#x6765;&#x7EC4;&#x7EC7;&#x8FDB;&#x7A0B;&#x7684;Binder&#x7EBF;&#x7A0B;&#x6C60;&#x3002;&#x8FDB;&#x7A0B;&#x53EF;&#x4EE5;&#x8C03;&#x7528;ioctl&#x5C06;&#x7EBF;&#x7A0B;&#x6CE8;&#x518C;&#x5230;Binder&#x9A71;&#x52A8;&#x4E2D;</span></div><div class="line">    <span class="comment">// &#x5F53;&#x6CA1;&#x6709;&#x8DB3;&#x591F;&#x7684;&#x7A7A;&#x95F2;&#x7EBF;&#x7A0B;&#x5904;&#x7406;&#x8FDB;&#x7A0B;&#x95F4;&#x901A;&#x4FE1;&#x8BF7;&#x6C42;&#x65F6;&#xFF0C;&#x9A71;&#x52A8;&#x53EF;&#x4EE5;&#x8981;&#x6C42;&#x8FDB;&#x7A0B;&#x6CE8;&#x518C;&#x66F4;&#x591A;&#x7684;&#x7EBF;&#x7A0B;&#x5230;Binder&#x7EBF;&#x7A0B;</span></div><div class="line">    <span class="comment">// &#x6C60;&#x4E2D;</span></div><div class="line">    <span class="keyword">struct</span> rb_root threads; </div><div class="line"></div><div class="line">    <span class="keyword">struct</span> rb_root nodes;           <span class="comment">// &#x7EC4;&#x7EC7;Binder&#x5B9E;&#x4F53;&#x5BF9;&#x8C61;&#xFF0C;&#x5B83;&#x4EE5;&#x6210;&#x5458;ptr&#x4F5C;&#x4E3A;key</span></div><div class="line">    <span class="keyword">struct</span> rb_root refs_by_desc;    <span class="comment">// &#x7EC4;&#x7EC7;Binder&#x5F15;&#x7528;&#x5BF9;&#x8C61;&#xFF0C;&#x5B83;&#x4EE5;&#x6210;&#x5458;desc&#x4F5C;&#x4E3A;key</span></div><div class="line">    <span class="keyword">struct</span> rb_root refs_by_node;    <span class="comment">// &#x7EC4;&#x7EC7;Binder&#x5F15;&#x7528;&#x5BF9;&#x8C61;&#xFF0C;&#x5B83;&#x4EE5;&#x6210;&#x5458;node&#x4F5C;&#x4E3A;key</span></div><div class="line">    <span class="keyword">int</span> pid;                        <span class="comment">// &#x6307;&#x5411;&#x8FDB;&#x7A0B;&#x7EC4;ID</span></div><div class="line">    <span class="keyword">struct</span> vm_area_struct *vma;     <span class="comment">// &#x5185;&#x6838;&#x7F13;&#x51B2;&#x533A;&#x7684;&#x7528;&#x6237;&#x7A7A;&#x95F4;&#x5730;&#x5740;&#xFF0C;&#x4F9B;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x4F7F;&#x7528;</span></div><div class="line">    <span class="keyword">struct</span> mm_struct *vma_vm_mm;</div><div class="line">    <span class="keyword">struct</span> task_struct *tsk;        <span class="comment">// &#x6307;&#x5411;&#x8FDB;&#x7A0B;&#x4EFB;&#x52A1;&#x63A7;&#x5236;&#x5757;</span></div><div class="line">    <span class="keyword">struct</span> files_struct *files;     <span class="comment">// &#x6307;&#x5411;&#x8FDB;&#x7A0B;&#x6253;&#x5F00;&#x6587;&#x4EF6;&#x7ED3;&#x6784;&#x4F53;&#x6570;&#x7EC4;</span></div><div class="line"></div><div class="line">    <span class="comment">// &#x4E00;&#x4E2A;hash&#x8868;&#xFF0C;&#x4FDD;&#x5B58;&#x8FDB;&#x7A0B;&#x53EF;&#x4EE5;&#x5EF6;&#x8FDF;&#x6267;&#x884C;&#x7684;&#x5DE5;&#x4F5C;&#x9879;&#xFF0C;&#x8FD9;&#x4E9B;&#x5EF6;&#x8FDF;&#x5DE5;&#x4F5C;&#x6709;&#x4E09;&#x79CD;&#x7C7B;&#x578B;</span></div><div class="line">    <span class="comment">// BINDER_DEFERRED_PUT_FILES&#x3001;BINDER_DEFERRED_FLUSH&#x3001;BINDER_DEFERRED_RELEASE</span></div><div class="line">    <span class="comment">// &#x9A71;&#x52A8;&#x4E3A;&#x8FDB;&#x7A0B;&#x5206;&#x914D;&#x5185;&#x6838;&#x7F13;&#x51B2;&#x533A;&#x65F6;&#xFF0C;&#x4F1A;&#x4E3A;&#x8BE5;&#x7F13;&#x51B2;&#x533A;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x6587;&#x4EF6;&#x63CF;&#x8FF0;&#x7B26;&#xFF0C;&#x8FDB;&#x7A0B;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x8BE5;&#x63CF;&#x8FF0;&#x7B26;&#x5C06;&#x8BE5;&#x5185;</span></div><div class="line">    <span class="comment">// &#x6838;&#x7F13;&#x51B2;&#x533A;&#x6620;&#x5C04;&#x5230;&#x81EA;&#x5DF1;&#x7684;&#x5730;&#x5740;&#x7A7A;&#x95F4;&#x3002;&#x5F53;&#x8FDB;&#x7A0B;&#x4E0D;&#x518D;&#x9700;&#x8981;&#x4F7F;&#x7528;Binder&#x673A;&#x5236;&#x65F6;&#xFF0C;&#x5C31;&#x4F1A;&#x901A;&#x77E5;&#x9A71;&#x52A8;&#x5173;&#x95ED;&#x8BE5;&#x6587;&#x4EF6;</span></div><div class="line">    <span class="comment">// &#x63CF;&#x8FF0;&#x7B26;&#x5E76;&#x91CA;&#x653E;&#x4E4B;&#x524D;&#x6240;&#x5206;&#x914D;&#x7684;&#x5185;&#x6838;&#x7F13;&#x51B2;&#x533A;&#x3002;&#x7531;&#x4E8E;&#x8FD9;&#x4E0D;&#x662F;&#x4E00;&#x4E2A;&#x9A6C;&#x4E0A;&#x5C31;&#x8981;&#x5B8C;&#x6210;&#x7684;&#x64CD;&#x4F5C;&#xFF0C;&#x56E0;&#x6B64;&#x9A71;&#x52A8;&#x4F1A;&#x521B;&#x5EFA;&#x4E00;</span></div><div class="line">    <span class="comment">// &#x4E2A;BINDER_DEFERRED_PUT_FILES&#x7C7B;&#x578B;&#x7684;&#x5DE5;&#x4F5C;&#x6765;&#x5EF6;&#x8FDF;&#x6267;&#x884C;&#xFF1B;</span></div><div class="line">    <span class="comment">// Binder&#x7EBF;&#x7A0B;&#x6C60;&#x4E2D;&#x7684;&#x7A7A;&#x95F2;Binder&#x7EBF;&#x7A0B;&#x662F;&#x7761;&#x7720;&#x5728;&#x4E00;&#x4E2A;&#x7B49;&#x5F85;&#x961F;&#x5217;&#x4E2D;&#x7684;&#xFF0C;&#x8FDB;&#x7A0B;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x8C03;&#x7528;&#x51FD;&#x6570;flush</span></div><div class="line">    <span class="comment">// &#x6765;&#x5524;&#x9192;&#x8FD9;&#x4E9B;&#x7EBF;&#x7A0B;&#xFF0C;&#x4EE5;&#x4FBF;&#x5B83;&#x4EEC;&#x53EF;&#x4EE5;&#x68C0;&#x67E5;&#x8FDB;&#x7A0B;&#x662F;&#x5426;&#x6709;&#x65B0;&#x7684;&#x5DE5;&#x4F5C;&#x9879;&#x9700;&#x8981;&#x5904;&#x7406;&#x3002;&#x6B64;&#x65F6;&#x9A71;&#x52A8;&#x4F1A;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;</span></div><div class="line">    <span class="comment">// BINDER_DEFERRED_FLUSH&#x7C7B;&#x578B;&#x7684;&#x5DE5;&#x4F5C;&#x9879;&#xFF0C;&#x4EE5;&#x4FBF;&#x5EF6;&#x8FDF;&#x6267;&#x884C;&#x5524;&#x9192;&#x7A7A;&#x95F2;Binder&#x7EBF;&#x7A0B;&#x7684;&#x64CD;&#x4F5C;&#xFF1B;</span></div><div class="line">    <span class="comment">// &#x5F53;&#x8FDB;&#x7A0B;&#x4E0D;&#x518D;&#x4F7F;&#x7528;Binder&#x673A;&#x5236;&#x65F6;&#xFF0C;&#x4F1A;&#x8C03;&#x7528;&#x51FD;&#x6570;close&#x5173;&#x95ED;&#x6587;&#x4EF6;/dev/binder&#xFF0C;&#x6B64;&#x65F6;&#x9A71;&#x52A8;&#x4F1A;&#x91CA;&#x653E;&#x4E4B;</span></div><div class="line">    <span class="comment">// &#x524D;&#x4E3A;&#x5B83;&#x5206;&#x914D;&#x7684;&#x8D44;&#x6E90;&#xFF0C;&#x7531;&#x4E8E;&#x8D44;&#x6E90;&#x91CA;&#x653E;&#x662F;&#x4E2A;&#x6BD4;&#x8F83;&#x8017;&#x65F6;&#x7684;&#x64CD;&#x4F5C;&#xFF0C;&#x9A71;&#x52A8;&#x4F1A;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;</span></div><div class="line">    <span class="comment">// BINDER_DEFERRED_RELEASE&#x7C7B;&#x578B;&#x7684;&#x4E8B;&#x52A1;&#x6765;&#x5EF6;&#x8FDF;&#x6267;&#x884C;</span></div><div class="line">    <span class="keyword">struct</span> hlist_node deferred_work_node;</div><div class="line"></div><div class="line">    <span class="keyword">int</span> deferred_work;              <span class="comment">// &#x63CF;&#x8FF0;&#x8BE5;&#x5EF6;&#x8FDF;&#x5DE5;&#x4F5C;&#x9879;&#x7684;&#x5177;&#x4F53;&#x7C7B;&#x578B;</span></div><div class="line">    <span class="keyword">void</span> *buffer;                   <span class="comment">// &#x5185;&#x6838;&#x7F13;&#x51B2;&#x533A;&#x7684;&#x5185;&#x6838;&#x7A7A;&#x95F4;&#x5730;&#x5740;&#xFF0C;&#x4F9B;&#x9A71;&#x52A8;&#x7A0B;&#x5E8F;&#x4F7F;&#x7528;</span></div><div class="line">    <span class="keyword">ptrdiff_t</span> user_buffer_offset;   <span class="comment">// vma&#x548C;buffer&#x4E4B;&#x95F4;&#x7684;&#x5DEE;&#x503C;</span></div><div class="line"></div><div class="line">    <span class="comment">// buffer&#x6307;&#x5411;&#x4E00;&#x5757;&#x5927;&#x7684;&#x5185;&#x6838;&#x7F13;&#x51B2;&#x533A;&#xFF0C;&#x9A71;&#x52A8;&#x7A0B;&#x5E8F;&#x4E3A;&#x65B9;&#x4FBF;&#x7BA1;&#x7406;&#xFF0C;&#x5C06;&#x5B83;&#x5212;&#x5206;&#x6210;&#x82E5;&#x5E72;&#x5C0F;&#x5757;&#xFF0C;&#x8FD9;&#x4E9B;&#x5C0F;&#x5757;&#x7684;&#x5185;&#x6838;&#x7F13;</span></div><div class="line">    <span class="comment">// &#x51B2;&#x533A;&#x7528;binder_buffer&#x63CF;&#x8FF0;&#x4FDD;&#x5B58;&#x5728;&#x5217;&#x8868;&#x4E2D;&#xFF0C;&#x6309;&#x5730;&#x5740;&#x4ECE;&#x5C0F;&#x5230;&#x5927;&#x6392;&#x5217;&#x3002;buffers&#x6307;&#x5411;&#x8BE5;&#x5217;&#x8868;&#x7684;&#x5934;&#x90E8;&#x3002;</span></div><div class="line">    <span class="keyword">struct</span> list_head buffers; </div><div class="line"></div><div class="line">    <span class="keyword">struct</span> rb_root free_buffers;      <span class="comment">// buffers&#x4E2D;&#x7684;&#x5C0F;&#x5757;&#x6709;&#x7684;&#x6B63;&#x5728;&#x4F7F;&#x7528;&#xFF0C;&#x88AB;&#x4FDD;&#x5B58;&#x5728;&#x6B64;&#x7EA2;&#x9ED1;&#x6811;</span></div><div class="line">    <span class="keyword">struct</span> rb_root allocated_buffers;   <span class="comment">// buffers&#x4E2D;&#x7684;&#x7A7A;&#x95F2;&#x5C0F;&#x5757;&#x88AB;&#x4FDD;&#x5B58;&#x5728;&#x6B64;&#x7EA2;&#x9ED1;&#x6811;</span></div><div class="line">    <span class="keyword">size_t</span> free_async_space;            <span class="comment">// &#x5F53;&#x524D;&#x53EF;&#x7528;&#x7684;&#x4FDD;&#x5B58;&#x5F02;&#x6B65;&#x4E8B;&#x52A1;&#x6570;&#x636E;&#x7684;&#x5185;&#x6838;&#x7F13;&#x51B2;&#x533A;&#x7684;&#x5927;&#x5C0F;</span></div><div class="line"></div><div class="line">    <span class="keyword">struct</span> page **pages;    <span class="comment">// buffer&#x548C;vma&#x90FD;&#x662F;&#x865A;&#x62DF;&#x5730;&#x5740;&#xFF0C;&#x5B83;&#x4EEC;&#x5BF9;&#x5E94;&#x7684;&#x7269;&#x7406;&#x9875;&#x9762;&#x4FDD;&#x5B58;&#x5728;pages</span></div><div class="line">                            <span class="comment">// &#x4E2D;&#xFF0C;&#x8FD9;&#x662F;&#x4E00;&#x4E2A;&#x6570;&#x7EC4;&#xFF0C;&#x6BCF;&#x4E2A;&#x5143;&#x7D20;&#x6307;&#x5411;&#x4E00;&#x4E2A;&#x7269;&#x7406;&#x9875;&#x9762;</span></div><div class="line">    <span class="keyword">size_t</span> buffer_size;     <span class="comment">// &#x8FDB;&#x7A0B;&#x8C03;&#x7528;mmap&#x5C06;&#x5B83;&#x6620;&#x5C04;&#x5230;&#x8FDB;&#x7A0B;&#x5730;&#x5740;&#x7A7A;&#x95F4;&#xFF0C;&#x5B9E;&#x9645;&#x4E0A;&#x662F;&#x8BF7;&#x6C42;&#x9A71;&#x52A8;&#x4E3A;&#x5B83;</span></div><div class="line">                            <span class="comment">// &#x5206;&#x914D;&#x4E00;&#x5757;&#x5185;&#x6838;&#x7F13;&#x51B2;&#x533A;&#xFF0C;&#x7F13;&#x51B2;&#x533A;&#x5927;&#x5C0F;&#x4FDD;&#x5B58;&#x5728;&#x8BE5;&#x6210;&#x5458;&#x4E2D;</span></div><div class="line">    <span class="keyword">uint32_t</span> buffer_free;   <span class="comment">// &#x7A7A;&#x95F2;&#x5185;&#x6838;&#x7F13;&#x51B2;&#x533A;&#x7684;&#x5927;&#x5C0F;</span></div><div class="line">    <span class="keyword">struct</span> list_head todo;  <span class="comment">// &#x5F53;&#x8FDB;&#x7A0B;&#x63A5;&#x6536;&#x5230;&#x4E00;&#x4E2A;&#x8FDB;&#x7A0B;&#x95F4;&#x901A;&#x4FE1;&#x8BF7;&#x6C42;&#x65F6;&#xFF0C;Binder&#x9A71;&#x52A8;&#x5C31;&#x5C06;&#x8BE5;&#x8BF7;&#x6C42;&#x5C01;</span></div><div class="line">                            <span class="comment">// &#x88C5;&#x6210;&#x4E00;&#x4E2A;&#x5DE5;&#x4F5C;&#x9879;&#xFF0C;&#x5E76;&#x4E14;&#x52A0;&#x5165;&#x5230;&#x8FDB;&#x7A0B;&#x7684;&#x5F85;&#x5904;&#x7406;&#x5DE5;&#x4F5C;&#x5411;&#x961F;&#x5217;&#x4E2D;&#xFF0C;&#x8BE5;&#x961F;&#x5217;</span></div><div class="line">                            <span class="comment">// &#x4F7F;&#x7528;&#x6210;&#x5458;&#x53D8;&#x91CF;todo&#x6765;&#x63CF;&#x8FF0;&#x3002;</span></div><div class="line">    <span class="keyword">wait_queue_head_t</span> wait; <span class="comment">// &#x7EBF;&#x7A0B;&#x6C60;&#x4E2D;&#x7A7A;&#x95F2;Binder&#x7EBF;&#x7A0B;&#x4F1A;&#x7761;&#x7720;&#x5728;&#x7531;&#x8BE5;&#x6210;&#x5458;&#x6240;&#x63CF;&#x8FF0;&#x7684;&#x7B49;&#x5F85;&#x961F;&#x5217;&#x4E2D;</span></div><div class="line">                            <span class="comment">// &#x5F53;&#x5BBF;&#x4E3B;&#x8FDB;&#x7A0B;&#x7684;&#x5F85;&#x5904;&#x7406;&#x5DE5;&#x4F5C;&#x9879;&#x961F;&#x5217;&#x589E;&#x52A0;&#x65B0;&#x5DE5;&#x4F5C;&#x9879;&#x540E;&#xFF0C;&#x9A71;&#x52A8;&#x4F1A;&#x5524;&#x9192;&#x8FD9;</span></div><div class="line">                            <span class="comment">// &#x4E9B;&#x7EBF;&#x7A0B;&#xFF0C;&#x4EE5;&#x4FBF;&#x5904;&#x7406;&#x65B0;&#x7684;&#x5DE5;&#x4F5C;&#x9879;</span></div><div class="line">    <span class="keyword">struct</span> binder_stats stats;  <span class="comment">// &#x7528;&#x6765;&#x7EDF;&#x8BA1;&#x8FDB;&#x7A0B;&#x6570;&#x636E;</span></div><div class="line"></div><div class="line">    <span class="comment">// &#x5F53;&#x8FDB;&#x7A0B;&#x6240;&#x5F15;&#x7528;&#x7684;Service&#x7EC4;&#x4EF6;&#x6B7B;&#x4EA1;&#x65F6;&#xFF0C;&#x9A71;&#x52A8;&#x4F1A;&#x5411;&#x8BE5;&#x8FDB;&#x7A0B;&#x53D1;&#x9001;&#x4E00;&#x4E2A;&#x6B7B;&#x4EA1;&#x901A;&#x77E5;&#x3002;&#x8FD9;&#x4E2A;&#x6B63;&#x5728;&#x53D1;&#x51FA;&#x7684;&#x901A;&#x77E5;&#x88AB;</span></div><div class="line">    <span class="comment">// &#x5C01;&#x88C5;&#x6210;&#x4E00;&#x4E2A;&#x7C7B;&#x578B;&#x4E3A;BINDER_WORK_DEAD_BINDER&#x6216;BINDER_WORK_DEAD_BINDER_AND_CLEAR</span></div><div class="line">    <span class="comment">// &#x7684;&#x5DE5;&#x4F5C;&#x9879;&#xFF0C;&#x5E76;&#x4FDD;&#x5B58;&#x5728;&#x7531;&#x8BE5;&#x6210;&#x5458;&#x63CF;&#x8FF0;&#x7684;&#x961F;&#x5217;&#x4E2D;&#x5220;&#x9664;</span></div><div class="line">    <span class="keyword">struct</span> list_head delivered_death;  </div><div class="line"></div><div class="line">    <span class="keyword">int</span> max_threads;        <span class="comment">// &#x9A71;&#x52A8;&#x7A0B;&#x5E8F;&#x6700;&#x591A;&#x53EF;&#x4EE5;&#x4E3B;&#x52A8;&#x8BF7;&#x6C42;&#x8FDB;&#x7A0B;&#x6CE8;&#x518C;&#x7684;&#x7EBF;&#x7A0B;&#x6570;</span></div><div class="line">    <span class="keyword">int</span> requested_threads;</div><div class="line">    <span class="keyword">int</span> requested_threads_started;</div><div class="line">    <span class="keyword">int</span> ready_threads;      <span class="comment">// &#x8FDB;&#x7A0B;&#x5F53;&#x524D;&#x7684;&#x7A7A;&#x95F2;Binder&#x7EBF;&#x7A0B;&#x6570;</span></div><div class="line">    <span class="keyword">long</span> default_priority;  <span class="comment">// &#x8FDB;&#x7A0B;&#x7684;&#x4F18;&#x5148;&#x7EA7;&#xFF0C;&#x5F53;&#x7EBF;&#x7A0B;&#x5904;&#x7406;&#x4E00;&#x4E2A;&#x5DE5;&#x4F5C;&#x9879;&#x65F6;&#xFF0C;&#x7EBF;&#x7A0B;&#x4F18;&#x5148;&#x7EA7;&#x53EF;&#x80FD;&#x88AB;</span></div><div class="line">                            <span class="comment">// &#x8BBE;&#x7F6E;&#x4E3A;&#x5BBF;&#x4E3B;&#x8FDB;&#x7A0B;&#x7684;&#x4F18;&#x5148;&#x7EA7;</span></div><div class="line">    <span class="keyword">struct</span> dentry *debugfs_entry;</div><div class="line">};</div></pre></td></tr></table></figure></p>
<h2 id="binder-proc&#x4E2D;&#x7684;&#x94FE;&#x8868;"><a href="#binder-proc&#x4E2D;&#x7684;&#x94FE;&#x8868;" class="headerlink" title="binder_proc&#x4E2D;&#x7684;&#x94FE;&#x8868;"></a>binder_proc&#x4E2D;&#x7684;&#x94FE;&#x8868;</h2><p>&#x5728;binder_proc&#x5185;&#x90E8;&#x6709;&#x82E5;&#x5E72;&#x4E2A;list_head&#x7C7B;&#x578B;&#x7684;&#x5B57;&#x6BB5;&#xFF0C;&#x7528;&#x6765;&#x628A;binder_proc&#x4E32;&#x5230;&#x4E0D;&#x540C;&#x7684;&#x94FE;&#x8868;&#x4E2D;&#x53BB;&#x3002;&#x4E00;&#x822C;&#x5199;&#x94FE;&#x8868;&#x7684;&#x505A;&#x6CD5;&#x662F;&#x5728;&#x94FE;&#x8868;&#x8282;&#x70B9;&#x7ED3;&#x6784;&#x4F53;&#x4E2D;&#x8FFD;&#x52A0;&#x4E1A;&#x52A1;&#x903B;&#x8F91;&#x5B57;&#x6BB5;&#xFF0C;&#x987A;&#x7740;&#x94FE;&#x8868;&#x7684;prev&#x3001;next&#x6307;&#x9488;&#x5230;&#x8FBE;&#x6307;&#x5B9A;&#x8282;&#x70B9;&#xFF0C;&#x7136;&#x540E;&#x518D;&#x8BBF;&#x95EE;&#x4E1A;&#x52A1;&#x903B;&#x8F91;&#x5B57;&#x6BB5;&#xFF1A;<br><img src="/2016/06/14/2016/0614BinderLearning12/img01.png" alt="&#x4E00;&#x822C;&#x7684;&#x94FE;&#x8868;&#x505A;&#x6CD5;"><br>&#x5728;Linux&#x4EE3;&#x7801;&#x4E2D;&#x5219;&#x5E38;&#x5E38;&#x53CD;&#x8FC7;&#x6765;&#xFF0C;&#x5148;&#x5B9A;&#x4E49;&#x4E1A;&#x52A1;&#x903B;&#x8F91;&#x7684;&#x7ED3;&#x6784;&#x4F53;&#xFF0C;&#x5728;&#x5176;&#x5185;&#x90E8;&#x5D4C;&#x5165;&#x94FE;&#x8868;&#x5B57;&#x6BB5;list_head&#xFF0C;&#x987A;&#x7740;&#x8BE5;&#x5B57;&#x6BB5;&#x904D;&#x5386;&#x94FE;&#x8868;&#xFF0C;&#x5728;&#x6BCF;&#x4E2A;&#x8282;&#x70B9;&#x4E0A;&#x6839;&#x636E;&#x8BE5;&#x5B57;&#x6BB5;&#x4E0E;&#x6240;&#x5728;&#x7ED3;&#x6784;&#x4F53;&#x7684;&#x504F;&#x79FB;&#x91CF;&#x627E;&#x5230;&#x6240;&#x5728;&#x7ED3;&#x6784;&#x4F53;&#xFF0C;&#x8BBF;&#x95EE;&#x4E1A;&#x52A1;&#x903B;&#x8F91;&#x5B57;&#x6BB5;&#xFF1A;<br><img src="/2016/06/14/2016/0614BinderLearning12/img02.png" alt="Linux&#x4E2D;&#x5E38;&#x7528;&#x7684;&#x94FE;&#x8868;&#x505A;&#x6CD5;"><br>&#x8FD9;&#x6837;&#x505A;&#x7684;&#x597D;&#x5904;&#x662F;&#x8BA9;&#x4E1A;&#x52A1;&#x903B;&#x8F91;&#x548C;&#x94FE;&#x8868;&#x903B;&#x8F91;&#x5206;&#x79BB;&#xFF0C;Linux&#x8FD8;&#x5B9A;&#x4E49;&#x4E86;&#x5B8F;&#x7528;&#x4E8E;&#x64CD;&#x4F5C;&#x94FE;&#x8868;&#xFF0C;&#x4EE5;&#x53CA;&#x6839;&#x636E;&#x94FE;&#x8868;&#x5B57;&#x6BB5;&#x627E;&#x5230;&#x6240;&#x5728;&#x7ED3;&#x6784;&#x4F53;&#x3002;&#x5982;binder_proc&#x7ED3;&#x6784;&#x4F53;&#x5185;&#x90E8;&#x76DB;&#x653E;&#x591A;&#x4E2A;list_head&#xFF0C;&#x8868;&#x793A;&#x628A;&#x8BE5;&#x7ED3;&#x6784;&#x4F53;&#x4E32;&#x5165;&#x4E86;&#x4E0D;&#x540C;&#x7684;&#x94FE;&#x8868;&#x3002;<br>&#x5177;&#x4F53;&#x6280;&#x5DE7;&#x53EF;&#x53C2;&#x89C1;&#x300A;Linux&#x5185;&#x6838;&#x8BBE;&#x8BA1;&#x4E0E;&#x5B9E;&#x73B0;&#x300B;&#x7B2C;6&#x7AE0;&#x3002;</p>
<h2 id="INIT-LIST-HEAD-amp-proc-gt-todo"><a href="#INIT-LIST-HEAD-amp-proc-gt-todo" class="headerlink" title="INIT_LIST_HEAD(&amp;proc-&gt;todo)"></a>INIT_LIST_HEAD(&amp;proc-&gt;todo)</h2><p>&#x56DE;&#x5230;binder_open(&#x2026;)&#xFF0C;&#x9664;&#x4E86;&#x76F4;&#x63A5;&#x5B57;&#x6BB5;&#x8D4B;&#x503C;&#xFF0C;&#x9700;&#x8981;&#x89E3;&#x91CA;&#x7684;&#x662F;&#x51E0;&#x4E2A;&#x94FE;&#x8868;&#x5B57;&#x6BB5;&#x7684;&#x5904;&#x7406;&#x3002;<br><code>INIT_LIST_HEAD(&amp;proc-&gt;todo)</code>&#x7528;&#x4E8E;&#x5C06;todo&#x7684;next&#x3001;prev&#x6307;&#x9488;&#x6307;&#x5411;&#x81EA;&#x5DF1;&#xFF0C;&#x8BE5;&#x5B8F;&#x7684;&#x5B9A;&#x4E49;&#x5728;kernel/goldfish/include/linux/lish.t:24<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">INIT_LIST_HEAD</span><span class="params">(<span class="keyword">struct</span> list_head *<span class="built_in">list</span>)</span></span></div><div class="line">{</div><div class="line">    <span class="built_in">list</span>-&gt;next = <span class="built_in">list</span>;</div><div class="line">    <span class="built_in">list</span>-&gt;prev = <span class="built_in">list</span>;</div><div class="line">}</div></pre></td></tr></table></figure></p>
<h2 id="init-waitqueue-head-amp-proc-gt-wait"><a href="#init-waitqueue-head-amp-proc-gt-wait" class="headerlink" title="init_waitqueue_head(&amp;proc-&gt;wait)"></a>init_waitqueue_head(&amp;proc-&gt;wait)</h2><p><code>init_waitqueue_head(&amp;proc-&gt;wait)</code>&#x8FD9;&#x4E2A;&#x5B8F;&#x5B9A;&#x4E49;&#x5728;kernel/goldfish/include/linux/wait.h:81<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">define</span> init_waitqueue_head(q)              \</span></div><div class="line">    do {                        \</div><div class="line">        static struct lock_class_key __key; \</div><div class="line">                            \</div><div class="line">        __init_waitqueue_head((q), #q, &amp;__key); \</div><div class="line">    } while (0)</div></pre></td></tr></table></figure></p>
<p><code>__init_waitqueue_head(...)</code>&#x5B9A;&#x4E49;&#x5728;kernel/goldfish/kernel/wait.c:13&#xFF0C;&#x4E3B;&#x8981;&#x5B8C;&#x6210;&#x4E86;&#x5BF9;task_list&#x5B57;&#x6BB5;&#x7684;&#x521D;&#x59CB;&#x5316;&#xFF1A;<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> <span class="number">__</span>init_waitqueue_head(<span class="keyword">wait_queue_head_t</span> *q, <span class="keyword">const</span> <span class="keyword">char</span> *name, <span class="keyword">struct</span> lock_class_key *key)</div><div class="line"><span class="comment">// q=(&amp;proc-&gt;todo)</span></div><div class="line">{</div><div class="line">    spin_lock_init(&amp;q-&gt;lock);</div><div class="line">    lockdep_set_class_and_name(&amp;q-&gt;lock, key, name);</div><div class="line">    INIT_LIST_HEAD(&amp;q-&gt;task_list);  <span class="comment">// &#x4E3A;&#x4EC0;&#x4E48;&#x4F7F;&#x7528;&#x7B26;&#x53F7;-&gt;&#x6765;&#x63D0;&#x9886;task_list&#x5462;&#xFF1F;</span></div><div class="line">}</div></pre></td></tr></table></figure></p>
<p>&#x8BF4;&#x5230;&#x5E95;&#x8FD8;&#x662F;&#x521D;&#x59CB;&#x5316;proc-&gt;wait-&gt;task_list&#x5B57;&#x6BB5;&#x3002;&#x4E0D;&#x8FC7;&#x6709;&#x70B9;&#x5947;&#x602A;task_list&#x662F;wait&#x5185;&#x7684;&#x7ED3;&#x6784;&#x4F53;&#xFF0C;&#x800C;&#x4E0D;&#x662F;&#x7ED3;&#x6784;&#x4F53;&#x6307;&#x9488;&#xFF0C;&#x4E3A;&#x4EC0;&#x4E48;&#x5BF9;task_list&#x7684;&#x63D0;&#x9886;&#x4F7F;&#x7528;&#x7B26;&#x53F7;<code>-&gt;</code>&#x5462;&#xFF1F;<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> binder_proc {</div><div class="line">    ......</div><div class="line">    <span class="keyword">wait_queue_head_t</span> wait;</div><div class="line">    ......</div><div class="line">};</div></pre></td></tr></table></figure></p>
<p>kernel/goldfish/include/linux/wait.h:53<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> <span class="number">__</span>wait_queue_head {</div><div class="line">    <span class="keyword">spinlock_t</span> lock;</div><div class="line">    <span class="keyword">struct</span> list_head task_list;</div><div class="line">};</div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="number">__</span>wait_queue_head <span class="keyword">wait_queue_head_t</span>;</div></pre></td></tr></table></figure></p>
<h2 id="hlist-add-head-amp-proc-gt-proc-node-amp-binder-procs"><a href="#hlist-add-head-amp-proc-gt-proc-node-amp-binder-procs" class="headerlink" title="hlist_add_head(&amp;proc-&gt;proc_node, &amp;binder_procs)"></a>hlist_add_head(&amp;proc-&gt;proc_node, &amp;binder_procs)</h2><p><code>hlist_add_head(&amp;proc-&gt;proc_node, &amp;binder_procs)</code>&#x5C06;proc-&gt;proc_node&#x8282;&#x70B9;&#x4E32;&#x5230;&#x5168;&#x5C40;&#x94FE;&#x8868;binder_procs&#x7684;&#x5934;&#x90E8;&#xFF0C;&#x5176;&#x5B9A;&#x4E49;&#x5728;kernel/goldfish/include/linux/list.h:610<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">hlist_add_head</span><span class="params">(<span class="keyword">struct</span> hlist_node *n, <span class="keyword">struct</span> hlist_head *h)</span></span></div><div class="line">{</div><div class="line">    <span class="keyword">struct</span> hlist_node *first = h-&gt;first;</div><div class="line">    n-&gt;next = first;</div><div class="line">    <span class="keyword">if</span> (first)</div><div class="line">        first-&gt;pprev = &amp;n-&gt;next;</div><div class="line">    h-&gt;first = n;</div><div class="line">    n-&gt;pprev = &amp;h-&gt;first;</div><div class="line">}</div></pre></td></tr></table></figure></p>
<p>kernel/goldfish/include/linux/types.h:233<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> hlist_head {</div><div class="line">    <span class="keyword">struct</span> hlist_node *first;</div><div class="line">};</div><div class="line"></div><div class="line"><span class="keyword">struct</span> hlist_node {</div><div class="line">    <span class="keyword">struct</span> hlist_node *next, **pprev;</div><div class="line">};</div></pre></td></tr></table></figure></p>
<p><img src="/2016/06/14/2016/0614BinderLearning12/img05.png" alt="&#x5C06;n&#x63D2;&#x5165;&#x5230;h"></p>
<p><img src="/2016/06/14/2016/0614BinderLearning12/img06.png" alt="&#x63D2;&#x5165;&#x540E;&#x7684;&#x7ED3;&#x679C;"><br>&#x7EFC;&#x4E0A;&#x6240;&#x8FF0;&#xFF0C;binder_open(&#x2026;)&#x7EC4;&#x7EC7;&#x7684;&#x6570;&#x636E;&#x7ED3;&#x6784;proc&#x4E3A;&#xFF1A;<br><img src="/2016/06/14/2016/0614BinderLearning12/img04.png" alt="binder_open(...)&#x7EC4;&#x7EC7;&#x7684;proc&#x6570;&#x636E;&#x7ED3;&#x6784;&#x56FE;"></p>
<h1 id="binder-mmap-&#x2026;-&#x90FD;&#x5E72;&#x4E86;&#x4EC0;&#x4E48;&#xFF1F;"><a href="#binder-mmap-&#x2026;-&#x90FD;&#x5E72;&#x4E86;&#x4EC0;&#x4E48;&#xFF1F;" class="headerlink" title="binder_mmap(&#x2026;)&#x90FD;&#x5E72;&#x4E86;&#x4EC0;&#x4E48;&#xFF1F;"></a>binder_mmap(&#x2026;)&#x90FD;&#x5E72;&#x4E86;&#x4EC0;&#x4E48;&#xFF1F;</h1><p>&#x63A5;&#x4E0B;&#x6765;&#x5C31;&#x662F;binder_mmap(&#x2026;)&#xFF0C;&#x5F53;&#x8FDB;&#x7A0B;&#x6253;&#x5F00;/dev/binder&#x4E4B;&#x540E;&#xFF0C;&#x5FC5;&#x987B;&#x8C03;&#x7528;mmap(&#x2026;)&#x51FD;&#x6570;&#x628A;&#x8BE5;&#x6587;&#x4EF6;&#x6620;&#x5C04;&#x5230;&#x8FDB;&#x7A0B;&#x7684;&#x5730;&#x5740;&#x7A7A;&#x95F4;&#x3002;<br>kernel/goldfish/drivers/staging/android/binder.c:2883<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">binder_mmap</span><span class="params">(<span class="keyword">struct</span> file *filp, <span class="keyword">struct</span> vm_area_struct *vma)</span></span></div><div class="line">{</div><div class="line">    <span class="keyword">int</span> ret;</div><div class="line">    <span class="keyword">struct</span> vm_struct *area; <span class="comment">// area&#x63CF;&#x8FF0;&#x5185;&#x6838;&#x5730;&#x5740;&#x7A7A;&#x95F4;&#xFF1B;vma&#x63CF;&#x8FF0;&#x7528;&#x6237;&#x5730;&#x5740;&#x7A7A;&#x95F4;</span></div><div class="line">    <span class="keyword">struct</span> binder_proc *proc = filp-&gt;private_data;</div><div class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *failure_string;</div><div class="line">    <span class="keyword">struct</span> binder_buffer *buffer;</div><div class="line"></div><div class="line">    ......</div><div class="line">    vma-&gt;vm_flags = (vma-&gt;vm_flags | VM_DONTCOPY) &amp; ~VM_MAYWRITE;</div><div class="line"></div><div class="line">    ......</div><div class="line">    <span class="comment">// &#x5728;&#x5185;&#x6838;&#x5730;&#x5740;&#x7A7A;&#x95F4;&#x5206;&#x914D;</span></div><div class="line">    area = get_vm_area(vma-&gt;vm_end - vma-&gt;vm_start, VM_IOREMAP);</div><div class="line">    ......</div><div class="line">    proc-&gt;buffer = area-&gt;addr;</div><div class="line">    proc-&gt;user_buffer_offset = vma-&gt;vm_start - (<span class="keyword">uintptr_t</span>)proc-&gt;buffer;</div><div class="line">    mutex_unlock(&amp;binder_mmap_lock);</div><div class="line">......</div><div class="line">    <span class="comment">// &#x521B;&#x5EFA;&#x7269;&#x7406;&#x9875;&#x9762;&#x7ED3;&#x6784;&#x4F53;&#x6307;&#x9488;&#x6570;&#x7EC4;</span></div><div class="line">    proc-&gt;pages = kzalloc(<span class="keyword">sizeof</span>(proc-&gt;pages[<span class="number">0</span>]) * ((vma-&gt;vm_end - vma-&gt;vm_start) / PAGE_SIZE), GFP_KERNEL);</div><div class="line">    ......</div><div class="line">    proc-&gt;buffer_size = vma-&gt;vm_end - vma-&gt;vm_start;</div><div class="line"></div><div class="line">    vma-&gt;vm_ops = &amp;binder_vm_ops;</div><div class="line">    vma-&gt;vm_private_data = proc;</div><div class="line"></div><div class="line">    <span class="comment">// &#x5206;&#x914D;&#x7269;&#x7406;&#x9875;&#x9762;&#xFF0C;&#x5E76;&#x5C06;&#x4E4B;&#x540C;&#x65F6;&#x6620;&#x5C04;&#x5230;&#x7528;&#x6237;&#x548C;&#x5185;&#x6838;&#x5730;&#x5740;&#x7A7A;&#x95F4;</span></div><div class="line">    <span class="keyword">if</span> (binder_update_page_range(proc, <span class="number">1</span>, proc-&gt;buffer, proc-&gt;buffer + PAGE_SIZE, vma)) {</div><div class="line">        ret = -ENOMEM;</div><div class="line">        failure_string = <span class="string">&quot;alloc small buf&quot;</span>;</div><div class="line">        <span class="keyword">goto</span> err_alloc_small_buf_failed;</div><div class="line">    }</div><div class="line">    buffer = proc-&gt;buffer;</div><div class="line">    INIT_LIST_HEAD(&amp;proc-&gt;buffers);</div><div class="line">    list_add(&amp;buffer-&gt;entry, &amp;proc-&gt;buffers); <span class="comment">// &#x628A;entry&#x4E32;&#x5230;buffers&#x94FE;&#x8868;&#x4E2D;</span></div><div class="line">    buffer-&gt;<span class="built_in">free</span> = <span class="number">1</span>;</div><div class="line">    binder_insert_free_buffer(proc, buffer);</div><div class="line">    proc-&gt;free_async_space = proc-&gt;buffer_size / <span class="number">2</span>;</div><div class="line">    barrier();</div><div class="line">    proc-&gt;files = get_files_struct(proc-&gt;tsk);</div><div class="line">    proc-&gt;vma = vma;</div><div class="line">    proc-&gt;vma_vm_mm = vma-&gt;vm_mm;</div><div class="line"></div><div class="line">    <span class="comment">/*printk(KERN_INFO &quot;binder_mmap: %d %lx-%lx maps %p\n&quot;,</span></div><div class="line">         proc-&gt;pid, vma-&gt;vm_start, vma-&gt;vm_end, proc-&gt;buffer);*/</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line"></div><div class="line">err_alloc_small_buf_failed:</div><div class="line">    kfree(proc-&gt;pages);</div><div class="line">    proc-&gt;pages = <span class="literal">NULL</span>;</div><div class="line">err_alloc_pages_failed:</div><div class="line">    mutex_lock(&amp;binder_mmap_lock);</div><div class="line">    vfree(proc-&gt;buffer);</div><div class="line">    proc-&gt;buffer = <span class="literal">NULL</span>;</div><div class="line">err_get_vm_area_failed:</div><div class="line">err_already_mapped:</div><div class="line">    mutex_unlock(&amp;binder_mmap_lock);</div><div class="line">err_bad_arg:</div><div class="line">    printk(KERN_ERR <span class="string">&quot;binder_mmap: %d %lx-%lx %s failed %d\n&quot;</span>,</div><div class="line">           proc-&gt;pid, vma-&gt;vm_start, vma-&gt;vm_end, failure_string, ret);</div><div class="line">    <span class="keyword">return</span> ret;</div><div class="line">}</div></pre></td></tr></table></figure></p>
<p>&#x5230;&#x7B2C;28&#x884C;&#x8C03;&#x7528;binder_update_page_range(&#x2026;)&#x4E4B;&#x524D;&#xFF0C;binder_mmap(&#x2026;)&#x5728;&#x5185;&#x6838;&#x5730;&#x5740;&#x7A7A;&#x95F4;&#x7533;&#x8BF7;&#x4E86;<code>struct vm_struct area</code>&#xFF0C;&#x5E76;&#x5B8C;&#x6210;&#x90E8;&#x5206;&#x6210;&#x5458;&#x7684;&#x521D;&#x59CB;&#x5316;&#xFF0C;&#x5982;&#x4E0B;&#xFF1A;<br><img src="/2016/06/14/2016/0614BinderLearning12/img07.png" alt="&#x5230;28&#x884C;&#x4E3A;&#x6B62;binder_mmap(...)&#x6784;&#x9020;&#x7684;&#x6570;&#x636E;&#x7ED3;&#x6784;"></p>
<h2 id="binder-update-page-range-&#x2026;-&#x505A;&#x4E86;&#x4EC0;&#x4E48;"><a href="#binder-update-page-range-&#x2026;-&#x505A;&#x4E86;&#x4EC0;&#x4E48;" class="headerlink" title="binder_update_page_range(&#x2026;)&#x505A;&#x4E86;&#x4EC0;&#x4E48;"></a>binder_update_page_range(&#x2026;)&#x505A;&#x4E86;&#x4EC0;&#x4E48;</h2><p>kernel/goldfish/drivers/staging/android/binder.c:627<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">binder_update_page_range</span><span class="params">(<span class="keyword">struct</span> binder_proc *proc, <span class="keyword">int</span> allocate,</span></span></div><div class="line">                    <span class="keyword">void</span> *start, <span class="keyword">void</span> *end,</div><div class="line">                    <span class="keyword">struct</span> vm_area_struct *vma)</div><div class="line">{</div><div class="line">    <span class="keyword">void</span> *page_addr;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> user_page_addr;</div><div class="line">    <span class="keyword">struct</span> vm_struct tmp_area;</div><div class="line">    <span class="keyword">struct</span> page **page;</div><div class="line">    <span class="keyword">struct</span> mm_struct *mm;</div><div class="line"></div><div class="line">    ... ...</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (vma)</div><div class="line">        mm = <span class="literal">NULL</span>;</div><div class="line">    <span class="keyword">else</span></div><div class="line">        mm = get_task_mm(proc-&gt;tsk);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (mm) {</div><div class="line">        down_write(&amp;mm-&gt;mmap_sem);</div><div class="line">        vma = proc-&gt;vma;</div><div class="line">        ... ...</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (allocate == <span class="number">0</span>) </div><div class="line">        <span class="keyword">goto</span> free_range;    <span class="comment">// &#x6267;&#x884C;&#x91CA;&#x653E;&#x903B;&#x8F91;</span></div><div class="line"></div><div class="line">    ... ...</div><div class="line"></div><div class="line">    <span class="comment">// &#x904D;&#x5386;&#x6240;&#x6709;&#x9875;&#x9762;</span></div><div class="line">    <span class="keyword">for</span> (page_addr = start; page_addr &lt; end; page_addr += PAGE_SIZE) {</div><div class="line">        <span class="keyword">int</span> ret;</div><div class="line">        <span class="keyword">struct</span> page **page_array_ptr;</div><div class="line">        page = &amp;proc-&gt;pages[(page_addr - proc-&gt;buffer) / PAGE_SIZE];</div><div class="line"></div><div class="line">        BUG_ON(*page);</div><div class="line">        *page = alloc_page(GFP_KERNEL | <span class="number">__</span>GFP_HIGHMEM | <span class="number">__</span>GFP_ZERO);</div><div class="line">        ... ...</div><div class="line">        <span class="comment">// &#x6620;&#x5C04;&#x5185;&#x6838;&#x5730;&#x5740;&#x7A7A;&#x95F4;</span></div><div class="line">        tmp_area.addr = page_addr;</div><div class="line">        tmp_area.size = PAGE_SIZE + PAGE_SIZE <span class="comment">/* guard page? */</span>;</div><div class="line">        page_array_ptr = page;</div><div class="line">        ret = map_vm_area(&amp;tmp_area, PAGE_KERNEL, &amp;page_array_ptr);</div><div class="line">        ... ...</div><div class="line"></div><div class="line">        <span class="comment">// &#x6620;&#x5C04;&#x7528;&#x6237;&#x5730;&#x5740;&#x7A7A;&#x95F4;</span></div><div class="line">        user_page_addr =</div><div class="line">            (<span class="keyword">uintptr_t</span>)page_addr + proc-&gt;user_buffer_offset;</div><div class="line">        ret = vm_insert_page(vma, user_page_addr, page[<span class="number">0</span>]);</div><div class="line">        ... ...</div><div class="line">    }</div><div class="line">    <span class="keyword">if</span> (mm) {</div><div class="line">        up_write(&amp;mm-&gt;mmap_sem);</div><div class="line">        mmput(mm);</div><div class="line">    }</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line"></div><div class="line">free_range:</div><div class="line">    <span class="keyword">for</span> (page_addr = end - PAGE_SIZE; page_addr &gt;= start;</div><div class="line">         page_addr -= PAGE_SIZE) {</div><div class="line">        page = &amp;proc-&gt;pages[(page_addr - proc-&gt;buffer) / PAGE_SIZE];</div><div class="line">        <span class="comment">// &#x89E3;&#x9664;&#x7269;&#x7406;&#x9875;&#x9762;&#x5728;&#x7528;&#x6237;&#x5730;&#x5740;&#x7A7A;&#x95F4;&#x548C;&#x5185;&#x6838;&#x5730;&#x5740;&#x7A7A;&#x95F4;&#x7684;&#x6620;&#x5C04;</span></div><div class="line">        <span class="keyword">if</span> (vma)</div><div class="line">            zap_page_range(vma, (<span class="keyword">uintptr_t</span>)page_addr +</div><div class="line">                proc-&gt;user_buffer_offset, PAGE_SIZE, <span class="literal">NULL</span>);</div><div class="line">err_vm_insert_page_failed:</div><div class="line">        unmap_kernel_range((<span class="keyword">unsigned</span> <span class="keyword">long</span>)page_addr, PAGE_SIZE);</div><div class="line">err_map_kernel_failed:</div><div class="line">        <span class="number">__f</span>ree_page(*page);     <span class="comment">// &#x91CA;&#x653E;&#x7269;&#x7406;&#x9875;&#x9762;</span></div><div class="line">        *page = <span class="literal">NULL</span>;</div><div class="line">err_alloc_page_failed:</div><div class="line">        ;</div><div class="line">    }</div><div class="line">err_no_vma:</div><div class="line">    <span class="keyword">if</span> (mm) {</div><div class="line">        up_write(&amp;mm-&gt;mmap_sem);</div><div class="line">        mmput(mm);</div><div class="line">    }</div><div class="line">    <span class="keyword">return</span> -ENOMEM;</div><div class="line">}</div></pre></td></tr></table></figure></p>
<h2 id="struct-binder-buffer"><a href="#struct-binder-buffer" class="headerlink" title="struct binder_buffer"></a>struct binder_buffer</h2><p>&#x4E4B;&#x540E;&#x5728;binder_mmap(&#x2026;)&#x7B2C;34&#x884C;&#xFF0C;buffer&#x7684;&#x7C7B;&#x578B;&#x662F;<code>struct binder_buffer*</code>&#xFF0C;&#x8BE5;&#x7ED3;&#x6784;&#x4F53;&#x7528;&#x6765;&#x63CF;&#x8FF0;&#x4E00;&#x4E2A;&#x5185;&#x6838;&#x7F13;&#x51B2;&#x533A;&#xFF0C;&#x8BE5;&#x7F13;&#x51B2;&#x533A;&#x7528;&#x4E8E;&#x5728;&#x8FDB;&#x7A0B;&#x95F4;&#x4F20;&#x8F93;&#x6570;&#x636E;&#x3002;<br>kernel/goldfish/drivers/staging/android/binder.c:263<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> binder_buffer {</div><div class="line">    <span class="comment">// &#x6BCF;&#x4E00;&#x4E2A;&#x4F7F;&#x7528;Binder&#x673A;&#x5236;&#x7684;&#x8FDB;&#x7A0B;&#x5728;Binder&#x9A71;&#x52A8;&#x4E2D;&#x90FD;&#x6709;&#x4E00;&#x4E2A;&#x5185;&#x6838;&#x7F13;&#x51B2;&#x533A;&#x5217;&#x8868;&#xFF0C;&#x7528;&#x6765;&#x4FDD;&#x5B58;Binder&#x9A71;&#x52A8;</span></div><div class="line">    <span class="comment">// &#x7A0B;&#x5E8F;&#x4E3A;&#x5B83;&#x5206;&#x914D;&#x7684;&#x5185;&#x6838;&#x7F13;&#x51B2;&#x533A;&#xFF0C;entry&#x662F;&#x8BE5;&#x5217;&#x8868;&#x7684;&#x4E00;&#x4E2A;&#x8282;&#x70B9;</span></div><div class="line">    <span class="keyword">struct</span> list_head entry; <span class="comment">/* free and allocated entries by address */</span> </div><div class="line"></div><div class="line">    <span class="comment">// &#x8FDB;&#x7A0B;&#x4F7F;&#x7528;&#x4E24;&#x4E2A;&#x7EA2;&#x9ED1;&#x6811;&#x5206;&#x522B;&#x4FDD;&#x5B58;&#x4F7F;&#x7528;&#x4E2D;&#x4EE5;&#x53CA;&#x7A7A;&#x95F2;&#x7684;&#x5185;&#x6838;&#x7F13;&#x51B2;&#x533A;&#x3002;&#x5982;&#x679C;&#x7A7A;&#x95F2;&#xFF0C;free=1&#xFF0C;</span></div><div class="line">    <span class="comment">//rb_node&#x5C31;&#x662F;&#x7A7A;&#x95F2;&#x5185;&#x6838;&#x7F13;&#x51B2;&#x533A;&#x7EA2;&#x9ED1;&#x6811;&#x4E2D;&#x7684;&#x8282;&#x70B9;&#xFF0C;&#x5426;&#x5219;&#x662F;&#x4F7F;&#x7528;&#x4E2D;&#x5185;&#x6838;&#x7F13;&#x51B2;&#x533A;&#x7EA2;&#x9ED1;&#x6811;&#x4E2D;&#x7684;&#x8282;&#x70B9;</span></div><div class="line">    <span class="keyword">struct</span> rb_node rb_node; <span class="comment">/* free entry by size or allocated entry */</span> </div><div class="line">                         <span class="comment">/* by address */</span>                       </div><div class="line"></div><div class="line">    <span class="keyword">unsigned</span> <span class="built_in">free</span>:<span class="number">1</span>;</div><div class="line">    <span class="comment">// Service&#x5904;&#x7406;&#x5B8C;&#x6210;&#x8BE5;&#x4E8B;&#x52A1;&#x540E;&#xFF0C;&#x82E5;&#x53D1;&#x73B0;allow_user_free&#x4E3A;1&#xFF0C;&#x4F1A;&#x8BF7;&#x6C42;&#x9A71;&#x52A8;&#x7A0B;&#x5E8F;&#x91CA;&#x653E;&#x8BE5;&#x5185;&#x6838;&#x7F13;&#x51B2;&#x533A;</span></div><div class="line">    <span class="keyword">unsigned</span> allow_user_free:<span class="number">1</span>;         </div><div class="line">    <span class="keyword">unsigned</span> async_transaction:<span class="number">1</span>;           <span class="comment">// &#x4E0E;&#x8BE5;&#x5185;&#x6838;&#x7F13;&#x51B2;&#x533A;&#x5173;&#x8054;&#x7684;&#x662F;&#x4E00;&#x4E2A;&#x5F02;&#x6B65;&#x4E8B;&#x52A1;</span></div><div class="line">    <span class="keyword">unsigned</span> debug_id:<span class="number">29</span>;</div><div class="line"></div><div class="line">    <span class="keyword">struct</span> binder_transaction *transaction; <span class="comment">// &#x5185;&#x6838;&#x7F13;&#x51B2;&#x533A;&#x6B63;&#x4EA4;&#x7ED9;&#x54EA;&#x4E2A;&#x4E8B;&#x52A1;&#x4F7F;&#x7528;</span></div><div class="line">    <span class="keyword">struct</span> binder_node *target_node;        <span class="comment">// &#x5185;&#x6838;&#x7F13;&#x51B2;&#x533A;&#x6B63;&#x4EA4;&#x7ED9;&#x54EA;&#x4E2A;Binder&#x5B9E;&#x4F53;&#x5BF9;&#x8C61;&#x4F7F;&#x7528;</span></div><div class="line">    <span class="keyword">size_t</span> data_size;</div><div class="line">    <span class="keyword">size_t</span> offsets_size;</div><div class="line"></div><div class="line">    <span class="comment">// &#x4FDD;&#x5B58;&#x901A;&#x4FE1;&#x6570;&#x636E;&#xFF0C;&#x5206;&#x4E24;&#x79CD;&#x7C7B;&#x578B;&#xFF1A;&#x666E;&#x901A;&#x6570;&#x636E;&#x3001;Binder&#x5BF9;&#x8C61;&#x3002;&#x9A71;&#x52A8;&#x7A0B;&#x5E8F;&#x4E0D;&#x5173;&#x5FC3;&#x666E;&#x901A;&#x6570;&#x636E;&#xFF0C;&#x4F46;&#x5FC5;&#x987B;&#x77E5;&#x9053;&#x91CC;&#x9762;</span></div><div class="line">    <span class="comment">// &#x7684;Binder&#x5BF9;&#x8C61;&#xFF0C;&#x56E0;&#x4E3A;&#x8981;&#x6839;&#x636E;&#x5B83;&#x4EEC;&#x6765;&#x7EF4;&#x62A4;&#x5185;&#x6838;&#x4E2D;Binder&#x5B9E;&#x4F53;&#x5BF9;&#x8C61;&#x548C;Binder&#x5F15;&#x7528;&#x5BF9;&#x8C61;&#x7684;&#x751F;&#x547D;&#x5468;&#x671F;&#x3002;</span></div><div class="line">    <span class="keyword">uint8_t</span> data[<span class="number">0</span>];                        </div><div class="line">};</div></pre></td></tr></table></figure></p>
<h2 id="list-add-amp-buffer-gt-entry-amp-proc-gt-buffers"><a href="#list-add-amp-buffer-gt-entry-amp-proc-gt-buffers" class="headerlink" title="list_add(&amp;buffer-&gt;entry, &amp;proc-&gt;buffers)"></a>list_add(&amp;buffer-&gt;entry, &amp;proc-&gt;buffers)</h2><p>&#x521D;&#x59CB;&#x5316;&#x5B8C;proc-&gt;buffers&#x4E4B;&#x540E;&#xFF0C;&#x7B2C;36&#x884C;&#x6267;&#x884C;&#x4E00;&#x4E2A;list_add(&#x2026;)&#xFF0C;&#x8BE5;&#x51FD;&#x6570;&#x5B9A;&#x4E49;&#x89C1;kernel/goldfish/include/linux/list.h:37~60<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="number">__l</span>ist_add(<span class="keyword">struct</span> list_head *<span class="keyword">new</span>,</div><div class="line">                  <span class="keyword">struct</span> list_head *prev,</div><div class="line">                  <span class="keyword">struct</span> list_head *next)</div><div class="line">{</div><div class="line">    next-&gt;prev = <span class="keyword">new</span>;</div><div class="line">    <span class="keyword">new</span>-&gt;next = next;</div><div class="line">    <span class="keyword">new</span>-&gt;prev = prev;</div><div class="line">    prev-&gt;next = <span class="keyword">new</span>;</div><div class="line">}</div><div class="line">... ...</div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">list_add</span><span class="params">(<span class="keyword">struct</span> list_head *<span class="keyword">new</span>, <span class="keyword">struct</span> list_head *head)</span></span></div><div class="line">{</div><div class="line">    <span class="number">__l</span>ist_add(<span class="keyword">new</span>, head, head-&gt;next);</div><div class="line">}</div></pre></td></tr></table></figure></p>
<p>&#x8FD0;&#x7B97;&#x8FC7;&#x7A0B;&#x5982;&#x4E0B;&#x56FE;&#xFF1A;<br><img src="/2016/06/14/2016/0614BinderLearning12/img08.png" alt="list_add&#x64CD;&#x4F5C;&#x8FC7;&#x7A0B;"><br>&#x4E8E;&#x662F;&#x5230;<code>binder_mmap(...)</code>&#x7B2C;37&#x884C;&#x4E3A;&#x6B62;&#xFF0C;binder_mmap(&#x2026;)&#x6784;&#x9020;&#x7684;&#x6570;&#x636E;&#x7ED3;&#x6784;&#x5982;&#x4E0B;&#xFF1A;<br><img src="/2016/06/14/2016/0614BinderLearning12/img09.png" alt="&#x5230;37&#x884C;&#x4E3A;&#x6B62;binder_mmap(...)&#x6784;&#x9020;&#x7684;&#x6570;&#x636E;&#x7ED3;&#x6784;"></p>
<h2 id="&#x51FD;&#x6570;binder-insert-free-buffer-&#x2026;"><a href="#&#x51FD;&#x6570;binder-insert-free-buffer-&#x2026;" class="headerlink" title="&#x51FD;&#x6570;binder_insert_free_buffer(&#x2026;)"></a>&#x51FD;&#x6570;binder_insert_free_buffer(&#x2026;)</h2><p>kernel/goldfish/drivers/statging/android/binder.c:545<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">binder_insert_free_buffer</span><span class="params">(<span class="keyword">struct</span> binder_proc *proc,</span></span></div><div class="line">                      <span class="keyword">struct</span> binder_buffer *new_buffer)</div><div class="line">{   <span class="comment">// new_buffer&#x5C31;&#x662F;&#x4E4B;&#x524D;&#x5206;&#x914D;&#x7684;buffer&#xFF0C;&#x88AB;&#x8F6C;&#x578B;&#x6210;&#x4E86;binder_buffer</span></div><div class="line">    <span class="keyword">struct</span> rb_node **p = &amp;proc-&gt;free_buffers.rb_node;</div><div class="line">    <span class="keyword">struct</span> rb_node *parent = <span class="literal">NULL</span>;</div><div class="line">    <span class="keyword">struct</span> binder_buffer *buffer;</div><div class="line">    <span class="keyword">size_t</span> buffer_size;</div><div class="line">    <span class="keyword">size_t</span> new_buffer_size;</div><div class="line">    ... ...</div><div class="line">    <span class="comment">// &#x8BA1;&#x7B97;binder_buffer&#x4E2D;data&#x90E8;&#x5206;&#x7684;&#x5927;&#x5C0F;</span></div><div class="line">    new_buffer_size = binder_buffer_size(proc, new_buffer);</div><div class="line"></div><div class="line">    ... ...</div><div class="line">    <span class="comment">// &#x6839;&#x636E;new_buffer&#x7684;&#x5927;&#x5C0F;&#xFF0C;&#x627E;&#x5230;&#x5728;proc-&gt;free_buffers&#x7EA2;&#x9ED1;&#x6811;&#x4E2D;&#x7684;&#x6B63;&#x786E;&#x4F4D;&#x7F6E;&#xFF0C;&#x5E76;&#x63D2;&#x5165;</span></div><div class="line">    <span class="keyword">while</span> (*p) {</div><div class="line">        parent = *p;</div><div class="line">        buffer = rb_entry(parent, <span class="keyword">struct</span> binder_buffer, rb_node);</div><div class="line">        BUG_ON(!buffer-&gt;<span class="built_in">free</span>);</div><div class="line"></div><div class="line">        buffer_size = binder_buffer_size(proc, buffer);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (new_buffer_size &lt; buffer_size)</div><div class="line">            p = &amp;parent-&gt;rb_left;</div><div class="line">        <span class="keyword">else</span></div><div class="line">            p = &amp;parent-&gt;rb_right;</div><div class="line">    }</div><div class="line">    rb_link_node(&amp;new_buffer-&gt;rb_node, parent, p);</div><div class="line">    rb_insert_color(&amp;new_buffer-&gt;rb_node, &amp;proc-&gt;free_buffers);</div><div class="line">}</div></pre></td></tr></table></figure></p>
<p>&#x4E8E;&#x662F;&#x5230;binder_mmap(&#x2026;)&#x7ED3;&#x675F;&#xFF0C;&#x8FD9;&#x4E2A;binder_proc&#x7ED3;&#x6784;&#x4F53;&#x5C31;&#x88AB;&#x505A;&#x6210;&#x4E86;&#x8FD9;&#x6837;&#xFF1A;<br><img src="/2016/06/14/2016/0614BinderLearning12/img10.png" alt="binder_mmap(...)&#x8C03;&#x7528;&#x5B8C;&#x6210;&#x540E;&#x6784;&#x9020;&#x7684;binder_proc&#x7ED3;&#x6784;&#x4F53;"></p>
<h1 id="&#x4ECE;&#x670D;&#x52A1;&#x7AEF;addService&#x89E6;&#x53D1;&#x7684;binder-transaction"><a href="#&#x4ECE;&#x670D;&#x52A1;&#x7AEF;addService&#x89E6;&#x53D1;&#x7684;binder-transaction" class="headerlink" title="&#x4ECE;&#x670D;&#x52A1;&#x7AEF;addService&#x89E6;&#x53D1;&#x7684;binder_transaction(...)"></a>&#x4ECE;&#x670D;&#x52A1;&#x7AEF;addService&#x89E6;&#x53D1;&#x7684;<code>binder_transaction(...)</code></h1><p>&#x4ECE;native&#x5C42;&#x7684;&#x8C03;&#x7528;&#x8FC7;&#x7A0B;&#x53C2;&#x89C1;<a href="https://palanceli.github.io/2016/05/28/2016/0528BinderLearning10/">binder&#x5B66;&#x4E60;&#x7B14;&#x8BB0;&#xFF08;&#x5341;&#xFF09;&#x2014;&#x2014; &#x7A7F;&#x8D8A;&#x5230;&#x9A71;&#x52A8;&#x5C42;</a>&#x3002;&#x6211;&#x4EEC;&#x4EE5;addService&#x4E3A;&#x4F8B;&#x6DF1;&#x5165;&#x5230;binder_transaction(&#x2026;)&#x5185;&#x90E8;&#xFF0C;<br>&#x4F20;&#x5165;&#x7684;<code>binder_transaction_data</code>&#x8F93;&#x5165;&#x53C2;&#x6570;&#x4E3A;&#xFF1A;<img src="https://palanceli.github.io/2016/05/11/2016/0514BinderLearning6/img02.png" alt="addService&#x7EC4;&#x7EC7;&#x7684;&#x8BF7;&#x6C42;&#x6570;&#x636E;"></p>
<p>kernel/goldfish/drivers/staging/android/binder.c:1402<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">binder_transaction</span><span class="params">(<span class="keyword">struct</span> binder_proc *proc,</span></span></div><div class="line">                   <span class="keyword">struct</span> binder_thread *thread,</div><div class="line">                   <span class="keyword">struct</span> binder_transaction_data *tr, <span class="keyword">int</span> reply)</div><div class="line">{   <span class="comment">// reply=(cmd==BC_REPLY)&#x5373;false&#xFF0C;flags=TF_ACCEPT_FDS</span></div><div class="line">    <span class="comment">// proc&#x548C;thread&#x8868;&#x793A;&#x5F53;&#x524D;&#x8FDB;&#x7A0B;&#x5BF9;&#x5E94;&#x7684;&#x6570;&#x636E;&#x7ED3;&#x6784;</span></div><div class="line">    <span class="keyword">struct</span> binder_transaction *t;</div><div class="line">    <span class="keyword">struct</span> binder_work *tcomplete;</div><div class="line">    <span class="keyword">size_t</span> *offp, *off_end;</div><div class="line">    <span class="keyword">struct</span> binder_proc *target_proc;</div><div class="line">    <span class="keyword">struct</span> binder_thread *target_thread = <span class="literal">NULL</span>;</div><div class="line">    <span class="keyword">struct</span> binder_node *target_node = <span class="literal">NULL</span>;</div><div class="line">    <span class="keyword">struct</span> list_head *target_list;</div><div class="line">    <span class="keyword">wait_queue_head_t</span> *target_wait;</div><div class="line">    <span class="keyword">struct</span> binder_transaction *in_reply_to = <span class="literal">NULL</span>;</div><div class="line">    <span class="keyword">struct</span> binder_transaction_log_entry *e;</div><div class="line">    <span class="keyword">uint32_t</span> return_error;</div><div class="line"></div><div class="line">    ......</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (reply) {</div><div class="line">        ......</div><div class="line">    } <span class="keyword">else</span> {</div><div class="line">        <span class="keyword">if</span> (tr-&gt;target.handle) {  <span class="comment">// tr-&gt;target.handle!=0</span></div><div class="line">            ......</div><div class="line">        } <span class="keyword">else</span> {</div><div class="line">            <span class="comment">// target_node&#x8868;&#x793A;binder&#x8BF7;&#x6C42;&#x8981;&#x53D1;&#x9001;&#x5230;&#x7684;&#x8282;&#x70B9;&#xFF0C;&#x6B64;&#x5904;&#x5373;</span></div><div class="line">            <span class="comment">// service manager&#x5BF9;&#x5E94;&#x7684;&#x8282;&#x70B9;</span></div><div class="line">            target_node = binder_context_mgr_node; </div><div class="line">            ......</div><div class="line">        }</div><div class="line">        ......</div><div class="line">        target_proc = target_node-&gt;proc; <span class="comment">// &#x5F97;&#x5230;&#x76EE;&#x6807;&#x8FDB;&#x7A0B;&#x7684;binder_proc</span></div><div class="line">        ......</div><div class="line">        <span class="comment">// &#x5F97;&#x5230;&#x76EE;&#x6807;&#x7EBF;&#x7A0B;tr-&gt;flags=TF_ACCEPT_FDS</span></div><div class="line">        <span class="comment">// thread&#x672A;&#x88AB;&#x64CD;&#x4F5C;&#x8FC7;&#xFF0C;&#x6545;transaction_stack&#x4E3A;0</span></div><div class="line">        <span class="keyword">if</span> (!(tr-&gt;flags &amp; TF_ONE_WAY) &amp;&amp; thread-&gt;transaction_stack) {</div><div class="line">            <span class="keyword">struct</span> binder_transaction *tmp;</div><div class="line">            tmp = thread-&gt;transaction_stack;</div><div class="line">            ... ...</div><div class="line">            <span class="keyword">while</span> (tmp) {</div><div class="line">                <span class="keyword">if</span> (tmp-&gt;from &amp;&amp; tmp-&gt;from-&gt;proc == target_proc)</div><div class="line">                    target_thread = tmp-&gt;from;</div><div class="line">                tmp = tmp-&gt;from_parent;</div><div class="line">            }</div><div class="line">        }</div><div class="line">    }</div><div class="line">    <span class="keyword">if</span> (target_thread) {</div><div class="line">        e-&gt;to_thread = target_thread-&gt;pid;</div><div class="line">        target_list = &amp;target_thread-&gt;todo;</div><div class="line">        target_wait = &amp;target_thread-&gt;wait;</div><div class="line">    } <span class="keyword">else</span> { <span class="comment">// &#x8D70;&#x8FD9;&#x91CC;</span></div><div class="line">        target_list = &amp;target_proc-&gt;todo;</div><div class="line">        target_wait = &amp;target_proc-&gt;wait;</div><div class="line">    }</div><div class="line">    ......</div><div class="line">    t = kzalloc(<span class="keyword">sizeof</span>(*t), GFP_KERNEL);  <span class="comment">// &#x521B;&#x5EFA;binder_transaction&#x8282;&#x70B9;</span></div><div class="line">    ......</div><div class="line">    tcomplete = kzalloc(<span class="keyword">sizeof</span>(*tcomplete), GFP_KERNEL);<span class="comment">//&#x521B;&#x5EFA;&#x4E00;&#x4E2A;binder_work&#x8282;&#x70B9;</span></div><div class="line">    ......</div><div class="line">    <span class="comment">// &#x8FD9;&#x91CC;&#x5C82;&#x4E0D;&#x662F;&#x4E3A;&#x771F;&#xFF1F;thread&#x6765;&#x81EA;binder_ioctl(...)&#x4E2D;&#x7684;binder_get_thread(proc)</span></div><div class="line">    <span class="comment">// &#x8FD4;&#x56DE;proc&#x7684;&#x5F53;&#x524D;&#x7EBF;&#x7A0B;</span></div><div class="line">    <span class="keyword">if</span> (!reply &amp;&amp; !(tr-&gt;flags &amp; TF_ONE_WAY)) </div><div class="line">        t-&gt;from = thread;</div><div class="line">    <span class="keyword">else</span></div><div class="line">        t-&gt;from = <span class="literal">NULL</span>;</div><div class="line">    t-&gt;sender_euid = proc-&gt;tsk-&gt;cred-&gt;euid; <span class="comment">// &#x6E90;&#x7EBF;&#x7A0B;&#x7528;&#x6237;id</span></div><div class="line">    t-&gt;to_proc = target_proc;               <span class="comment">// &#x8D1F;&#x8D23;&#x5904;&#x7406;&#x8BE5;&#x4E8B;&#x52A1;&#x7684;&#x8FDB;&#x7A0B;&#xFF0C;sm</span></div><div class="line">    t-&gt;to_thread = target_thread;           <span class="comment">// &#x8D1F;&#x8D23;&#x5904;&#x7406;&#x8BE5;&#x4E8B;&#x52A1;&#x7684;&#x7EBF;&#x7A0B;</span></div><div class="line">    t-&gt;code = tr-&gt;code;                     <span class="comment">// ADD_SERVICE_TRANSACTION</span></div><div class="line">    t-&gt;flags = tr-&gt;flags;                   <span class="comment">// TF_ACCEPT_FDS</span></div><div class="line">    t-&gt;priority = task_nice(current);       <span class="comment">// &#x6E90;&#x7EBF;&#x7A0B;&#x4F18;&#x5148;&#x7EA7;</span></div><div class="line">    ... ...</div><div class="line">    t-&gt;buffer = binder_alloc_buf(target_proc, tr-&gt;data_size,</div><div class="line">        tr-&gt;offsets_size, !reply &amp;&amp; (t-&gt;flags &amp; TF_ONE_WAY));</div><div class="line">    ......</div><div class="line">    t-&gt;buffer-&gt;allow_user_free = <span class="number">0</span>;<span class="comment">// Service&#x5904;&#x7406;&#x5B8C;&#x8BE5;&#x4E8B;&#x52A1;&#x540E;&#xFF0C;&#x9A71;&#x52A8;&#x4E0D;&#x4F1A;&#x91CA;&#x653E;&#x8BE5;&#x5185;&#x6838;&#x7F13;&#x51B2;&#x533A;</span></div><div class="line">    t-&gt;buffer-&gt;debug_id = t-&gt;debug_id;</div><div class="line">    t-&gt;buffer-&gt;transaction = t; <span class="comment">// &#x7F13;&#x51B2;&#x533A;&#x6B63;&#x4EA4;&#x7ED9;&#x54EA;&#x4E2A;&#x4E8B;&#x52A1;&#x4F7F;&#x7528;</span></div><div class="line">    t-&gt;buffer-&gt;target_node = target_node;   <span class="comment">// &#x7F13;&#x51B2;&#x533A;&#x6B63;&#x4EA4;&#x7ED9;&#x54EA;&#x4E2A;Binder&#x5B9E;&#x4F53;&#x5BF9;&#x8C61;&#x4F7F;&#x7528;</span></div><div class="line">    ......</div><div class="line">    <span class="keyword">if</span> (target_node)</div><div class="line">        binder_inc_node(target_node, <span class="number">1</span>, <span class="number">0</span>, <span class="literal">NULL</span>);</div><div class="line">    <span class="comment">// &#x5206;&#x6790;&#x6240;&#x4F20;&#x6570;&#x636E;&#x4E2D;&#x7684;&#x6240;&#x6709;binder&#x5BF9;&#x8C61;&#xFF0C;&#x5982;&#x679C;&#x662F;binder&#x5B9E;&#x4F53;&#xFF0C;&#x5728;&#x7EA2;&#x9ED1;&#x6811;&#x4E2D;&#x6DFB;&#x52A0;&#x76F8;&#x5E94;&#x7684;&#x8282;&#x70B9;&#x3002;</span></div><div class="line">    <span class="comment">// &#x9996;&#x5148;&#xFF0C;&#x4ECE;&#x7528;&#x6237;&#x6001;&#x83B7;&#x53D6;&#x6240;&#x4F20;&#x8F93;&#x7684;&#x6570;&#x636E;&#xFF0C;&#x4EE5;&#x53CA;&#x6570;&#x636E;&#x91CC;&#x7684;binder&#x5BF9;&#x8C61;&#x504F;&#x79FB;&#x4FE1;&#x606F;&#x3002;</span></div><div class="line">    offp = (<span class="keyword">size_t</span> *)(t-&gt;buffer-&gt;data + ALIGN(tr-&gt;data_size, <span class="keyword">sizeof</span>(<span class="keyword">void</span> *)));</div><div class="line">    <span class="comment">// &#x5C06;&#x670D;&#x52A1;&#x7AEF;&#x4F20;&#x6765;&#x7684;Parcel&#x7684;&#x6570;&#x636E;&#x90E8;&#x5206;&#x62F7;&#x8D1D;&#x5230;&#x5185;&#x6838;&#x7A7A;&#x95F4;</span></div><div class="line">    <span class="keyword">if</span> (copy_from_user(t-&gt;buffer-&gt;data, tr-&gt;data.ptr.buffer, tr-&gt;data_size)) {</div><div class="line">        ......</div><div class="line">    }</div><div class="line">    <span class="comment">// &#x5C06;&#x670D;&#x52A1;&#x7AEF;&#x4F20;&#x6765;&#x7684;Parcel&#x7684;&#x504F;&#x79FB;&#x6570;&#x7EC4;&#x62F7;&#x8D1D;&#x5230;&#x5185;&#x6838;&#x7A7A;&#x95F4;</span></div><div class="line">    <span class="keyword">if</span> (copy_from_user(offp, tr-&gt;data.ptr.offsets, tr-&gt;offsets_size)) {</div><div class="line">        ......</div><div class="line">    }</div><div class="line">    ......</div><div class="line">    off_end = (<span class="keyword">void</span> *)offp + tr-&gt;offsets_size;</div><div class="line">    <span class="comment">// &#x904D;&#x5386;&#x6BCF;&#x4E2A;flat_binder_object&#x4FE1;&#x606F;&#xFF0C;&#x521B;&#x5EFA;&#x5FC5;&#x8981;&#x7684;&#x7EA2;&#x9ED1;&#x6811;&#x8282;&#x70B9;</span></div><div class="line">    <span class="keyword">for</span> (; offp &lt; off_end; offp++) {</div><div class="line">        <span class="keyword">struct</span> flat_binder_object *fp;</div><div class="line">        ......</div><div class="line">        fp = (<span class="keyword">struct</span> flat_binder_object *)(t-&gt;buffer-&gt;data + *offp);</div><div class="line">        <span class="keyword">switch</span> (fp-&gt;type) {</div><div class="line">        <span class="keyword">case</span> BINDER_TYPE_BINDER:</div><div class="line">        <span class="keyword">case</span> BINDER_TYPE_WEAK_BINDER: { <span class="comment">// &#x5982;&#x679C;&#x662F;binder&#x5B9E;&#x4F53;</span></div><div class="line">            <span class="keyword">struct</span> binder_ref *ref;</div><div class="line">            <span class="comment">// fp-&gt;binder&#x662F;BnTestService::getWeakRefs()&#xFF0C;BnTestService&#x7684;&#x5F71;&#x5B50;&#x5BF9;&#x8C61;</span></div><div class="line">            <span class="comment">// binder_get_node(...)&#x5728;proc-&gt;nodes.rb_node&#x4E2D;&#x627E;fp-&gt;binder&#xFF0C;&#x5982;&#x679C;&#x6CA1;&#x6709;</span></div><div class="line">            <span class="comment">// &#x627E;&#x5230;&#xFF0C;&#x5219;&#x5728;&#x8BE5;&#x7EA2;&#x9ED1;&#x6811;&#x4E2D;&#x4E3A;fp-&gt;binder&#x521B;&#x5EFA;&#x8282;&#x70B9;</span></div><div class="line">            <span class="keyword">struct</span> binder_node *node = binder_get_node(proc, fp-&gt;binder);</div><div class="line">            <span class="keyword">if</span> (node == <span class="literal">NULL</span>) {</div><div class="line">                node = binder_new_node(proc, fp-&gt;binder, fp-&gt;cookie);</div><div class="line">                ......</div><div class="line">                node-&gt;min_priority = fp-&gt;flags &amp; FLAT_BINDER_FLAG_PRIORITY_MASK;</div><div class="line">                node-&gt;accept_fds = !!(fp-&gt;flags &amp; FLAT_BINDER_FLAG_ACCEPTS_FDS);</div><div class="line">            }</div><div class="line">            ......</div><div class="line">            <span class="comment">// &#x5FC5;&#x8981;&#x65F6;&#xFF0C;&#x4F1A;&#x5728;&#x76EE;&#x6807;&#x8FDB;&#x7A0B;&#x7684;binder_proc&#x4E2D;&#x521B;&#x5EFA;&#x5BF9;&#x5E94;&#x7684;binder_ref&#x7EA2;&#x9ED1;&#x6811;&#x8282;&#x70B9;</span></div><div class="line">            ref = binder_get_ref_for_node(target_proc, node);</div><div class="line">            ......</div><div class="line">            <span class="keyword">if</span> (fp-&gt;type == BINDER_TYPE_BINDER)</div><div class="line">                fp-&gt;type = BINDER_TYPE_HANDLE;</div><div class="line">            <span class="keyword">else</span></div><div class="line">                fp-&gt;type = BINDER_TYPE_WEAK_HANDLE;</div><div class="line">            <span class="comment">// &#x4FEE;&#x6539;&#x6240;&#x4F20;&#x6570;&#x636E;&#x4E2D;&#x7684;flat_binder_object&#x4FE1;&#x606F;&#xFF0C;&#x56E0;&#x4E3A;&#x8FDC;&#x7AEF;&#x7684;binder&#x5B9E;&#x4F53;&#x5230;</span></div><div class="line">            <span class="comment">// &#x4E86;&#x76EE;&#x6807;&#x7AEF;&#x5C31;&#x53D8;&#x4E3A;binder&#x4EE3;&#x7406;&#x4E86;&#xFF0C;&#x6240;&#x4EE5;&#x8981;&#x8BB0;&#x5F55;&#x4E0B;binder&#x53E5;&#x67C4;&#x4E86;&#x3002;</span></div><div class="line">            fp-&gt;handle = ref-&gt;desc;</div><div class="line">            binder_inc_ref(ref, fp-&gt;type == BINDER_TYPE_HANDLE,</div><div class="line">                       &amp;thread-&gt;todo);</div><div class="line">            ......</div><div class="line">        } <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">case</span> BINDER_TYPE_HANDLE:</div><div class="line">        <span class="keyword">case</span> BINDER_TYPE_WEAK_HANDLE: { </div><div class="line">            <span class="comment">// &#x5BF9;flat_binder_object&#x505A;&#x5FC5;&#x8981;&#x7684;&#x4FEE;&#x6539;&#xFF0C;&#x6BD4;&#x5982;&#x5C06;BINDER_TYPE_HANDLE&#x6539;&#x4E3A;</span></div><div class="line">            <span class="comment">// BINDER_TYPE_BINDER</span></div><div class="line">            <span class="keyword">struct</span> binder_ref *ref = binder_get_ref(proc, fp-&gt;handle);</div><div class="line">            ......</div><div class="line">            <span class="keyword">if</span> (ref-&gt;node-&gt;proc == target_proc) {</div><div class="line">                <span class="keyword">if</span> (fp-&gt;type == BINDER_TYPE_HANDLE)</div><div class="line">                    fp-&gt;type = BINDER_TYPE_BINDER;</div><div class="line">                <span class="keyword">else</span></div><div class="line">                    fp-&gt;type = BINDER_TYPE_WEAK_BINDER;</div><div class="line">                fp-&gt;binder = ref-&gt;node-&gt;ptr;</div><div class="line">                fp-&gt;cookie = ref-&gt;node-&gt;cookie;</div><div class="line">                binder_inc_node(ref-&gt;node, fp-&gt;type == BINDER_TYPE_BINDER, <span class="number">0</span>, <span class="literal">NULL</span>);</div><div class="line">                trace_binder_transaction_ref_to_node(t, ref);</div><div class="line">                ... ...</div><div class="line">            } <span class="keyword">else</span> {</div><div class="line">                <span class="keyword">struct</span> binder_ref *new_ref;</div><div class="line">                new_ref = binder_get_ref_for_node(target_proc, ref-&gt;node);</div><div class="line">                <span class="keyword">if</span> (new_ref == <span class="literal">NULL</span>) {</div><div class="line">                    return_error = BR_FAILED_REPLY;</div><div class="line">                    <span class="keyword">goto</span> err_binder_get_ref_for_node_failed;</div><div class="line">                }</div><div class="line">                fp-&gt;handle = new_ref-&gt;desc;</div><div class="line">                binder_inc_ref(new_ref, fp-&gt;type == BINDER_TYPE_HANDLE, <span class="literal">NULL</span>);</div><div class="line">                trace_binder_transaction_ref_to_ref(t, ref,</div><div class="line">                                    new_ref);</div><div class="line">                ... ...</div><div class="line">            }</div><div class="line">        } <span class="keyword">break</span>;</div><div class="line"></div><div class="line">        <span class="keyword">case</span> BINDER_TYPE_FD: {</div><div class="line">            <span class="keyword">int</span> target_fd;</div><div class="line">            <span class="keyword">struct</span> file *file;</div><div class="line">            ... ...</div><div class="line"></div><div class="line">            file = fget(fp-&gt;handle);</div><div class="line">            ... ...</div><div class="line">            target_fd = task_get_unused_fd_flags(target_proc, O_CLOEXEC);</div><div class="line">            ... ...</div><div class="line">            task_fd_install(target_proc, target_fd, file);</div><div class="line">            trace_binder_transaction_fd(t, fp-&gt;handle, target_fd);</div><div class="line">            binder_debug(BINDER_DEBUG_TRANSACTION,</div><div class="line">                     <span class="string">&quot;        fd %ld -&gt; %d\n&quot;</span>, fp-&gt;handle, target_fd);</div><div class="line">            <span class="comment">/* <span class="doctag">TODO:</span> fput? */</span></div><div class="line">            fp-&gt;handle = target_fd;</div><div class="line">        } <span class="keyword">break</span>;</div><div class="line"></div><div class="line">        <span class="keyword">default</span>:</div><div class="line">            ... ...</div><div class="line">            return_error = BR_FAILED_REPLY;</div><div class="line">            <span class="keyword">goto</span> err_bad_object_type;</div><div class="line">        }</div><div class="line">    }</div><div class="line">    <span class="keyword">if</span> (reply) {</div><div class="line">        ......</div><div class="line">    } <span class="keyword">else</span> <span class="keyword">if</span> (!(t-&gt;flags &amp; TF_ONE_WAY)) {</div><div class="line">        ... ...</div><div class="line">        t-&gt;need_reply = <span class="number">1</span>;</div><div class="line">        t-&gt;from_parent = thread-&gt;transaction_stack;</div><div class="line">        thread-&gt;transaction_stack = t;</div><div class="line">    } <span class="keyword">else</span> {</div><div class="line">        ......</div><div class="line">        <span class="keyword">if</span> (target_node-&gt;has_async_transaction) {</div><div class="line">            target_list = &amp;target_node-&gt;async_todo;</div><div class="line">            target_wait = <span class="literal">NULL</span>;</div><div class="line">        } <span class="keyword">else</span></div><div class="line">            target_node-&gt;has_async_transaction = <span class="number">1</span>;</div><div class="line">    }</div><div class="line">    t-&gt;work.type = BINDER_WORK_TRANSACTION;</div><div class="line">    <span class="comment">// &#x628A;binder_transaction&#x8282;&#x70B9;&#x63D2;&#x5165;target_list&#xFF08;&#x5373;&#x76EE;&#x6807;todo&#x961F;&#x5217;&#xFF09;</span></div><div class="line">    list_add_tail(&amp;t-&gt;work.entry, target_list);</div><div class="line">    tcomplete-&gt;type = BINDER_WORK_TRANSACTION_COMPLETE;</div><div class="line">    list_add_tail(&amp;tcomplete-&gt;entry, &amp;thread-&gt;todo);</div><div class="line">    <span class="keyword">if</span> (target_wait) <span class="comment">// &#x4F20;&#x8F93;&#x52A8;&#x4F5C;&#x5B8C;&#x6BD5;&#xFF0C;&#x73B0;&#x5728;&#x53EF;&#x4EE5;&#x5524;&#x9192;&#x7CFB;&#x7EDF;&#x4E2D;&#x5176;&#x5B83;&#x76F8;&#x5173;&#x7EBF;&#x7A0B;&#xFF0C;wake up!</span></div><div class="line">        wake_up_interruptible(target_wait);</div><div class="line">    <span class="keyword">return</span>;</div><div class="line"></div><div class="line">err_get_unused_fd_failed:</div><div class="line">err_fget_failed:</div><div class="line">err_fd_not_allowed:</div><div class="line">err_binder_get_ref_for_node_failed:</div><div class="line">err_binder_get_ref_failed:</div><div class="line">err_binder_new_node_failed:</div><div class="line">err_bad_object_type:</div><div class="line">err_bad_offset:</div><div class="line">err_copy_data_failed:</div><div class="line">    trace_binder_transaction_failed_buffer_release(t-&gt;buffer);</div><div class="line">    binder_transaction_buffer_release(target_proc, t-&gt;buffer, offp);</div><div class="line">    t-&gt;buffer-&gt;transaction = <span class="literal">NULL</span>;</div><div class="line">    binder_free_buf(target_proc, t-&gt;buffer);</div><div class="line">err_binder_alloc_buf_failed:</div><div class="line">    kfree(tcomplete);</div><div class="line">    binder_stats_deleted(BINDER_STAT_TRANSACTION_COMPLETE);</div><div class="line">err_alloc_tcomplete_failed:</div><div class="line">    kfree(t);</div><div class="line">    binder_stats_deleted(BINDER_STAT_TRANSACTION);</div><div class="line">err_alloc_t_failed:</div><div class="line">err_bad_call_stack:</div><div class="line">err_empty_call_stack:</div><div class="line">err_dead_binder:</div><div class="line">err_invalid_target_handle:</div><div class="line">err_no_context_mgr_node:</div><div class="line">    binder_debug(BINDER_DEBUG_FAILED_TRANSACTION,</div><div class="line">             <span class="string">&quot;binder: %d:%d transaction failed %d, size %zd-%zd\n&quot;</span>,</div><div class="line">             proc-&gt;pid, thread-&gt;pid, return_error,</div><div class="line">             tr-&gt;data_size, tr-&gt;offsets_size);</div><div class="line"></div><div class="line">    {</div><div class="line">        <span class="keyword">struct</span> binder_transaction_log_entry *fe;</div><div class="line">        fe = binder_transaction_log_add(&amp;binder_transaction_log_failed);</div><div class="line">        *fe = *e;</div><div class="line">    }</div><div class="line"></div><div class="line">    BUG_ON(thread-&gt;return_error != BR_OK);</div><div class="line">    <span class="keyword">if</span> (in_reply_to) {</div><div class="line">        thread-&gt;return_error = BR_TRANSACTION_COMPLETE;</div><div class="line">        binder_send_failed_reply(in_reply_to, return_error);</div><div class="line">    } <span class="keyword">else</span></div><div class="line">        thread-&gt;return_error = return_error;</div><div class="line">}</div></pre></td></tr></table></figure></p>
<h2 id="struct-binder-transaction"><a href="#struct-binder-transaction" class="headerlink" title="struct binder_transaction"></a>struct binder_transaction</h2><p>&#x5728;&#x51FD;&#x6570;binder_transaction(&#x2026;)&#x7B2C;53&#x884C;&#x521B;&#x5EFA;&#x4E86;&#x7ED3;&#x6784;&#x4F53;binder_transaction&#xFF0C;&#x8BE5;&#x7ED3;&#x6784;&#x4F53;&#x7528;&#x6765;&#x63CF;&#x8FF0;&#x8FDB;&#x7A0B;&#x95F4;&#x901A;&#x4FE1;&#x8FC7;&#x7A0B;&#xFF0C;&#x5373;&#x4E8B;&#x52A1;&#x3002;&#x5176;&#x5B9A;&#x4E49;&#x5728;kernel/goldfish/drivers/staging/android/binder.c:346<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> binder_transaction {</div><div class="line">    <span class="keyword">int</span> debug_id;</div><div class="line"></div><div class="line">    <span class="comment">// &#x5F53;&#x9A71;&#x52A8;&#x4E3A;&#x76EE;&#x6807;&#x8FDB;&#x7A0B;&#x6216;&#x7EBF;&#x7A0B;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x4E8B;&#x52A1;&#x65F6;&#xFF0C;&#x5C31;&#x4F1A;&#x5C06;&#x8BE5;&#x6210;&#x5458;&#x7684;type&#x7F6E;&#x4E3A;</span></div><div class="line">    <span class="comment">// BINDER_WORK_TRANSACTION&#xFF0C;&#x5E76;&#x5C06;&#x5B83;&#x6DFB;&#x52A0;&#x5230;&#x76EE;&#x6807;&#x8FDB;&#x7A0B;&#x6216;&#x7EBF;&#x7A0B;&#x7684;todo&#x961F;&#x5217;&#xFF0C;&#x7B49;&#x5F85;&#x5904;&#x7406;</span></div><div class="line">    <span class="keyword">struct</span> binder_work work;</div><div class="line"></div><div class="line">    <span class="keyword">struct</span> binder_thread *from;         <span class="comment">// &#x53D1;&#x8D77;&#x4E8B;&#x52A1;&#x7684;&#x7EBF;&#x7A0B;</span></div><div class="line"></div><div class="line">    <span class="comment">// &#x4E8B;&#x52A1;&#x6240;&#x4F9D;&#x8D56;&#x7684;&#x53E6;&#x5916;&#x4E00;&#x4E2A;&#x4E8B;&#x52A1;&#x4EE5;&#x53CA;&#x76EE;&#x6807;&#x7EBF;&#x7A0B;&#x4E0B;&#x4E00;&#x4E2A;&#x8981;&#x5904;&#x7406;&#x7684;&#x4E8B;&#x52A1;</span></div><div class="line">    <span class="keyword">struct</span> binder_transaction *from_parent; </div><div class="line"></div><div class="line">    <span class="keyword">struct</span> binder_proc *to_proc;        <span class="comment">// &#x8D1F;&#x8D23;&#x5904;&#x7406;&#x8BE5;&#x4E8B;&#x52A1;&#x7684;&#x8FDB;&#x7A0B;</span></div><div class="line">    <span class="keyword">struct</span> binder_thread *to_thread;    <span class="comment">// &#x8D1F;&#x8D23;&#x5904;&#x7406;&#x8BE5;&#x4E8B;&#x52A1;&#x7684;&#x7EBF;&#x7A0B;</span></div><div class="line">    <span class="keyword">struct</span> binder_transaction *to_parent;</div><div class="line">    <span class="keyword">unsigned</span> need_reply:<span class="number">1</span>;              <span class="comment">// &#x540C;&#x6B65;&#x4E8B;&#x52A1;&#x4E3A;1&#x9700;&#x8981;&#x7B49;&#x5F85;&#x5BF9;&#x65B9;&#x56DE;&#x590D;&#xFF1B;&#x5F02;&#x6B65;&#x4E3A;0</span></div><div class="line">    <span class="comment">/* unsigned is_dead:1; */</span>   <span class="comment">/* not used at the moment */</span></div><div class="line"></div><div class="line">    <span class="comment">// &#x6307;&#x5411;&#x9A71;&#x52A8;&#x4E3A;&#x8BE5;&#x4E8B;&#x52A1;&#x5206;&#x914D;&#x7684;&#x5185;&#x6838;&#x7F13;&#x51B2;&#x533A;&#xFF0C;&#x4FDD;&#x5B58;&#x4E86;&#x8FDB;&#x7A0B;&#x95F4;&#x901A;&#x4FE1;&#x6570;&#x636E;</span></div><div class="line">    <span class="keyword">struct</span> binder_buffer *buffer;   </div><div class="line"></div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span>    code;   <span class="comment">// &#x76F4;&#x63A5;&#x4ECE;&#x8FDB;&#x7A0B;&#x95F4;&#x901A;&#x4FE1;&#x6570;&#x636E;&#x4E2D;&#x62F7;&#x8D1D;&#x8FC7;&#x6765;</span></div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span>    flags;  <span class="comment">// &#x76F4;&#x63A5;&#x4ECE;&#x8FDB;&#x7A0B;&#x95F4;&#x901A;&#x4FE1;&#x6570;&#x636E;&#x4E2D;&#x62F7;&#x8D1D;&#x8FC7;&#x6765;</span></div><div class="line">    <span class="keyword">long</span>    priority;       <span class="comment">// &#x6E90;&#x7EBF;&#x7A0B;&#x4F18;&#x5148;&#x7EA7;</span></div><div class="line"></div><div class="line">    <span class="comment">// &#x7EBF;&#x7A0B;&#x5728;&#x5904;&#x7406;&#x4E8B;&#x52A1;&#x65F6;&#xFF0C;&#x9A71;&#x52A8;&#x4F1A;&#x4FEE;&#x6539;&#x5B83;&#x7684;&#x4F18;&#x5148;&#x7EA7;&#x4EE5;&#x6EE1;&#x8DB3;&#x6E90;&#x7EBF;&#x7A0B;&#x548C;&#x76EE;&#x6807;Service&#x7EC4;&#x5EFA;&#x7684;&#x8981;&#x6C42;&#x3002;&#x5728;&#x4FEE;&#x6539;&#x4E4B;</span></div><div class="line">    <span class="comment">// &#x524D;&#xFF0C;&#x4F1A;&#x5C06;&#x5B83;&#x539F;&#x6765;&#x7684;&#x7EBF;&#x7A0B;&#x4F18;&#x5148;&#x7EA7;&#x4FDD;&#x5B58;&#x5728;&#x8BE5;&#x6210;&#x5458;&#x4E2D;&#xFF0C;&#x4EE5;&#x4FBF;&#x7EBF;&#x7A0B;&#x5904;&#x7406;&#x5B8C;&#x8BE5;&#x4E8B;&#x52A1;&#x540E;&#x53EF;&#x4EE5;&#x6062;&#x590D;&#x539F;&#x6765;&#x7684;&#x4F18;&#x5148;&#x7EA7;</span></div><div class="line">    <span class="keyword">long</span>    saved_priority; </div><div class="line">    <span class="keyword">uid_t</span>   sender_euid;    <span class="comment">// &#x6E90;&#x7EBF;&#x7A0B;&#x7528;&#x6237;ID</span></div><div class="line">};</div></pre></td></tr></table></figure></p>
<h2 id="struct-binder-work"><a href="#struct-binder-work" class="headerlink" title="struct binder_work"></a>struct binder_work</h2><p>&#x5728;binder_transaction(&#x2026;)&#x7B2C;55&#x884C;&#x521B;&#x5EFA;&#x4E86;struct binder_work&#xFF0C;&#x8BE5;&#x7ED3;&#x6784;&#x4F53;&#x7528;&#x4E8E;&#x63CF;&#x8FF0;&#x5F85;&#x5904;&#x7406;&#x7684;&#x5DE5;&#x4F5C;&#x9879;&#xFF0C;&#x5176;&#x5B9A;&#x4E49;&#x5728;kernel/goldfish/drivers/staging/android/binder.c:205<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> binder_work {        </div><div class="line">    <span class="keyword">struct</span> list_head entry; <span class="comment">// &#x7528;&#x6765;&#x5C06;&#x8BE5;&#x7ED3;&#x6784;&#x4F53;&#x5D4C;&#x5165;&#x5230;&#x4E00;&#x4E2A;&#x5BBF;&#x4E3B;&#x7ED3;&#x6784;&#x4E2D;</span></div><div class="line">    <span class="comment">// &#x63CF;&#x8FF0;&#x5DE5;&#x4F5C;&#x9879;&#x7684;&#x7C7B;&#x578B;&#xFF0C;&#x6839;&#x636E;&#x53D6;&#x503C;&#xFF0C;Binder&#x9A71;&#x52A8;&#x7A0B;&#x5E8F;&#x5C31;&#x53EF;&#x4EE5;&#x5224;&#x65AD;&#x51FA;&#x4E00;&#x4E2A;binder_work&#x7ED3;&#x6784;&#x4F53;&#x5D4C;&#x5165;&#x5230;</span></div><div class="line">    <span class="comment">// &#x4EC0;&#x4E48;&#x7C7B;&#x578B;&#x7684;&#x5BBF;&#x4E3B;&#x7ED3;&#x6784;&#x4E2D;</span></div><div class="line">    <span class="keyword">enum</span> {</div><div class="line">        BINDER_WORK_TRANSACTION = <span class="number">1</span>,</div><div class="line">        BINDER_WORK_TRANSACTION_COMPLETE,</div><div class="line">        BINDER_WORK_NODE,</div><div class="line">        BINDER_WORK_DEAD_BINDER,</div><div class="line">        BINDER_WORK_DEAD_BINDER_AND_CLEAR,</div><div class="line">        BINDER_WORK_CLEAR_DEATH_NOTIFICATION,</div><div class="line">    } type;             </div><div class="line">};</div></pre></td></tr></table></figure></p>
<p>&#x5230;binder_transaction(&#x2026;)&#x7B2C;92&#x884C;&#x4E3A;&#x6B62;&#xFF0C;&#x5B83;&#x6784;&#x9020;&#x7684;&#x6570;&#x636E;&#x7ED3;&#x6784;&#x5982;&#x4E0B;&#x3002;&#x6B64;&#x65F6;&#x7528;&#x6237;&#x63A7;&#x4EF6;&#x7684;&#x90E8;&#x5206;&#x6570;&#x636E;&#x88AB;&#x62F7;&#x8D1D;&#x5230;&#x4E86;&#x5185;&#x6838;&#x7A7A;&#x95F4;&#xFF0C;&#x5185;&#x6838;&#x7A7A;&#x95F4;&#x4E2D;binder_transaction&#x7684;buffer&#x662F;&#x4ECE;proc-&gt;free_buffers&#x4E2D;&#x6458;&#x53D6;&#x4E0B;&#x6765;&#x7684;&#xFF0C;&#x4E3A;&#x4E86;&#x907F;&#x514D;&#x56FE;&#x7247;&#x8FC7;&#x5927;&#xFF0C;&#x6B64;&#x5904;&#x7684;&#x7EC6;&#x8282;&#x6682;&#x4E0D;&#x5C55;&#x73B0;&#x4E86;&#x3002;&#x6458;&#x53D6;&#x4E0B;&#x7684;buffer&#x7684;&#x6570;&#x636E;&#x90E8;&#x5206;&#x7528;&#x4E8E;&#x6682;&#x5B58;&#x4ECE;&#x7528;&#x6237;&#x7A7A;&#x95F4;&#x62F7;&#x8D1D;&#x6765;&#x7684;&#x6570;&#x636E;&#x3002;<br><img src="/2016/06/14/2016/0614BinderLearning12/img11.png" alt="&#x5230;binder_transaction(...)&#x7B2C;92&#x884C;&#x4F4D;&#x7F6E;&#xFF0C;&#x6784;&#x9020;&#x7684;&#x6570;&#x636E;&#x7ED3;&#x6784;"></p>
<h2 id="struct-binder-node"><a href="#struct-binder-node" class="headerlink" title="struct binder_node"></a>struct binder_node</h2><p>&#x4ECE;94&#x884C;&#x5F00;&#x59CB;&#xFF0C;&#x9010;&#x4E2A;&#x904D;&#x5386;t-&gt;buffer.data&#x4E2D;&#x7684;binder objects&#xFF0C;&#x5728;for&#x5FAA;&#x73AF;&#x4E2D;&#xFF0C;fp&#x6307;&#x5411;&#x5F53;&#x524D;&#x7684;binder object&#x3002;&#x5982;&#x679C;fp-&gt;type&#x662F;BINDER_TYPE_BINDER&#x6216;BINDER_TYPE_WEAK_BINDER&#xFF0C;#104&#x5148;&#x4ECE;proc-&gt;nodes.rb_node&#x4E2D;&#x67E5;&#x627E;&#x6709;&#x6CA1;&#x6709;fp-&gt;binder&#xFF0C;&#x5982;&#x679C;&#x6CA1;&#x6709;&#x5219;&#x8C03;&#x7528;binder_new_node(&#x2026;)&#x5728;proc-&gt;nodes.rb_node&#x4E2D;&#x521B;&#x5EFA;&#x6B64;&#x8282;&#x70B9;&#x3002;&#x63A5;&#x4E0B;&#x6765;&#x5148;&#x770B;&#x770B;<code>struct binder_node</code>&#xFF0C;kernel/goldfish/drivers/staging/android/binder.c:217&#xFF0C;&#x5B83;&#x7528;&#x6765;&#x63CF;&#x8FF0;&#x4E00;&#x4E2A;Binder&#x5B9E;&#x4F53;&#x5BF9;&#x8C61;&#xFF0C;&#x6BCF;&#x4E00;&#x4E2A;Service&#x7EC4;&#x4EF6;&#x5728;&#x9A71;&#x52A8;&#x5C42;&#x90FD;&#x5BF9;&#x5E94;&#x4E00;&#x4E2A;binder_node&#xFF0C;&#x7528;&#x6765;&#x63CF;&#x8FF0;&#x5728;&#x5185;&#x6838;&#x4E2D;&#x7684;&#x72B6;&#x6001;&#xFF1A;<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> binder_node {            </div><div class="line">    <span class="keyword">int</span> debug_id;               <span class="comment">// &#x5E2E;&#x52A9;&#x8C03;&#x8BD5;&#x7528;&#x7684;</span></div><div class="line"></div><div class="line">    <span class="comment">// &#x5F53;Binder&#x5B9E;&#x4F53;&#x5BF9;&#x8C61;&#x7684;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x7531;0&#x53D8;&#x4E3A;1&#x6216;&#x7531;1&#x53D8;&#x4E3A;0&#x65F6;&#xFF0C;Binder&#x9A71;&#x52A8;&#x7A0B;&#x5E8F;&#x5C31;&#x4F1A;&#x8BF7;&#x6C42;&#x76F8;&#x5E94;&#x7684;</span></div><div class="line">    <span class="comment">// Service&#x7EC4;&#x4EF6;&#x589E;&#x52A0;&#x6216;&#x51CF;&#x5C11;&#x5176;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x3002;Binder&#x9A71;&#x52A8;&#x7A0B;&#x5E8F;&#x5C31;&#x4F1A;&#x5C06;&#x201C;&#x8BE5;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x4FEE;&#x6539;&#x201D;&#x5C01;&#x88C5;&#x6210;&#x4E00;&#x4E2A;&#x7C7B;</span></div><div class="line">    <span class="comment">// &#x578B;&#x4E3A;&#x4E00;&#x4E2A;&#x7C7B;&#x578B;&#x4E3A;binder_node&#x7684;&#x5DE5;&#x4F5C;&#x9879;&#xFF0C;&#x5373;&#x5C06;&#x6210;&#x5458;work&#x7684;&#x503C;&#x7F6E;&#x4E3A;BINDER_WORK_NODE&#xFF0C;&#x5E76;&#x5C06;</span></div><div class="line">    <span class="comment">// &#x5B83;&#x6DFB;&#x52A0;&#x5230;&#x76F8;&#x5E94;&#x8FDB;&#x7A0B;&#x7684;todo&#x961F;&#x5217;&#x4E2D;&#x7B49;&#x5F85;&#x5904;&#x7406;</span></div><div class="line">    <span class="keyword">struct</span> binder_work work;</div><div class="line"></div><div class="line">    <span class="keyword">union</span> {</div><div class="line">        <span class="keyword">struct</span> rb_node rb_node;</div><div class="line">        <span class="keyword">struct</span> hlist_node dead_node;</div><div class="line">    };</div><div class="line"></div><div class="line">    <span class="comment">// &#x6307;&#x5411;&#x5BBF;&#x4E3B;&#x8FDB;&#x7A0B;&#xFF0C;&#x5BBF;&#x4E3B;&#x8FDB;&#x7A0B;&#x4F7F;&#x7528;&#x4E00;&#x4E2A;&#x7EA2;&#x9ED1;&#x6811;&#x6765;&#x7EF4;&#x62A4;&#x5B83;&#x5185;&#x90E8;&#x6240;&#x6709;Binder&#x5B9E;&#x4F53;&#x5BF9;&#x8C61;&#xFF0C;&#x800C;&#x6BCF;&#x4E00;&#x4E2A;</span></div><div class="line">    <span class="comment">// Binder&#x5B9E;&#x4F53;&#x5BF9;&#x8C61;&#x7684;&#x6210;&#x5458;&#x53D8;&#x91CF;rb_node&#x5C31;&#x6B63;&#x597D;&#x662F;&#x8FD9;&#x4E2A;&#x7EA2;&#x9ED1;&#x6811;&#x7684;&#x4E00;&#x4E2A;&#x8282;&#x70B9;&#x3002;&#x5982;&#x679C;Binder&#x5B9E;&#x4F53;&#x5BF9;&#x8C61;</span></div><div class="line">    <span class="comment">// &#x7684;&#x5BBF;&#x4E3B;&#x8FDB;&#x7A0B;&#x5DF2;&#x7ECF;&#x6B7B;&#x4EA1;&#xFF0C;&#x90A3;&#x4E48;&#x8BE5;Binder&#x5B9E;&#x4F53;&#x5BF9;&#x8C61;&#x5C31;&#x4F1A;&#x901A;&#x8FC7;&#x5B83;&#x7684;&#x6210;&#x5458;&#x53D8;&#x91CF;dead_node&#x4FDD;&#x5B58;&#x5728;&#x4E00;&#x4E2A;&#x5168;</span></div><div class="line">    <span class="comment">// &#x5C40;&#x7684;hash&#x5217;&#x8868;&#x4E2D;&#x3002;</span></div><div class="line">    <span class="keyword">struct</span> binder_proc *proc;</div><div class="line"></div><div class="line">    <span class="comment">// &#x4E00;&#x4E2A;Binder&#x5B9E;&#x4F53;&#x5BF9;&#x8C61;&#x53EF;&#x80FD;&#x4F1A;&#x540C;&#x65F6;&#x88AB;&#x591A;&#x4E2A;Client&#x7EC4;&#x4EF6;&#x5F15;&#x7528;&#xFF0C;&#x56E0;&#x6B64;Binder&#x9A71;&#x52A8;&#x4F7F;&#x7528;&#x7ED3;&#x6784;&#x4F53;</span></div><div class="line">    <span class="comment">// binder_ref&#x6765;&#x63CF;&#x8FF0;&#x8FD9;&#x4E9B;&#x5F15;&#x7528;&#x5173;&#x7CFB;&#xFF0C;&#x5E76;&#x4E14;&#x5C06;&#x5F15;&#x7528;&#x4E86;&#x540C;&#x4E00;&#x4E2A;Binder&#x5B9E;&#x4F53;&#x5BF9;&#x8C61;&#x7684;&#x6240;&#x6709;&#x5F15;&#x7528;&#x90FD;&#x4FDD;&#x5B58;&#x5728;</span></div><div class="line">    <span class="comment">// &#x4E00;&#x4E2A;hash&#x5217;&#x8868;&#x4E2D;&#x3002;&#x8FD9;&#x4E2A;hash&#x5217;&#x8868;&#x901A;&#x8FC7;Binder&#x5B9E;&#x4F53;&#x5BF9;&#x8C61;&#x7684;refs&#x6210;&#x5458;&#x6765;&#x63CF;&#x8FF0;&#xFF0C;&#x800C;Binder&#x9A71;&#x52A8;&#x901A;</span></div><div class="line">    <span class="comment">// &#x8FC7;refs&#x5C31;&#x53EF;&#x4EE5;&#x77E5;&#x9053;&#x6709;&#x54EA;&#x4E9B;Client&#x7EC4;&#x4EF6;&#x5F15;&#x7528;&#x4E86;&#x540C;&#x4E00;&#x4E2A;Binder&#x5B9E;&#x4F53;&#x5BF9;&#x8C61;</span></div><div class="line">    <span class="keyword">struct</span> hlist_head refs;</div><div class="line"></div><div class="line">    <span class="keyword">int</span> internal_strong_refs;       <span class="comment">// &#x63CF;&#x8FF0;Bidner&#x5B9E;&#x4F53;&#x5BF9;&#x8C61;&#x7684;&#x5F3A;&#x5F15;&#x7528;&#x8BA1;&#x6570;</span></div><div class="line">    <span class="keyword">int</span> local_weak_refs;            <span class="comment">// &#x63CF;&#x8FF0;Binder&#x5B9E;&#x4F53;&#x5BF9;&#x8C61;&#x7684;&#x5F31;&#x5F15;&#x7528;&#x8BA1;&#x6570;</span></div><div class="line">    <span class="keyword">int</span> local_strong_refs;          <span class="comment">// &#x63CF;&#x8FF0;Bidner&#x5B9E;&#x4F53;&#x5BF9;&#x8C61;&#x7684;&#x5F3A;&#x5F15;&#x7528;&#x8BA1;&#x6570;</span></div><div class="line"></div><div class="line">    <span class="keyword">void</span> <span class="number">__u</span>ser *ptr;       <span class="comment">// &#x63CF;&#x8FF0;&#x7528;&#x6237;&#x7A7A;&#x95F4;&#x4E2D;&#x7684;Service&#x7EC4;&#x4EF6;&#xFF0C;&#x6307;&#x5411;Service&#x7684;&#x5F71;&#x5B50;&#x5BF9;&#x8C61;</span></div><div class="line">    <span class="keyword">void</span> <span class="number">__u</span>ser *cookie;    <span class="comment">// &#x63CF;&#x8FF0;&#x7528;&#x6237;&#x7A7A;&#x95F4;&#x4E2D;&#x7684;Service&#x7EC4;&#x4EF6;&#x7684;&#x5730;&#x5740;&#xFF0C;&#x6307;&#x5411;Service&#x7684;&#x5730;&#x5740;</span></div><div class="line"></div><div class="line">     <span class="comment">// &#x5F53;Binder&#x5B9E;&#x4F53;&#x5BF9;&#x8C61;&#x8BF7;&#x6C42;Service&#x6267;&#x884C;&#x67D0;&#x4E2A;&#x64CD;&#x4F5C;&#x65F6;&#xFF0C;&#x4F1A;&#x589E;&#x52A0;&#x8BE5;Service&#x7684;&#x5F3A;/&#x5F31;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#xFF0C;</span></div><div class="line">     <span class="comment">// has_strong_ref&#x548C;has_weak_ref&#x88AB;&#x7F6E;1&#xFF1B;</span></div><div class="line">     <span class="comment">// &#x5F53;Service&#x5B8C;&#x6210;Binder&#x6240;&#x8BF7;&#x6C42;&#x7684;&#x64CD;&#x4F5C;&#x540E;&#xFF0C;&#x4F1A;&#x9012;&#x51CF;&#x8BE5;Service&#x7684;&#x5F3A;/&#x5F31;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#xFF0C;has_strong_ref&#x548C;has_weak_ref&#x88AB;&#x7F6E;0&#xFF1B;</span></div><div class="line">     <span class="comment">// Binder&#x5B9E;&#x4F53;&#x5728;&#x8BF7;&#x6C42;Service&#x589E;/&#x51CF;&#x5F3A;/&#x5F31;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x7684;&#x8FC7;&#x7A0B;&#x4E2D;&#xFF0C;&#x4F1A;&#x5C06;</span></div><div class="line">     <span class="comment">// pending_strong_ref&#x6216;pending_weak_ref&#x7F6E;1&#xFF1B;</span></div><div class="line">     <span class="comment">// &#x5F53;Service&#x5B8C;&#x6210;&#x589E;/&#x51CF;&#x5F3A;/&#x5F31;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x4E4B;&#x540E;&#xFF0C;&#x4F1A;&#x5C06;&#x8FD9;&#x4E24;&#x4E2A;&#x6210;&#x5458;&#x53D8;&#x91CF;&#x7F6E;&#x4E3A;0&#x3002;</span></div><div class="line">    <span class="keyword">unsigned</span> has_strong_ref:<span class="number">1</span>;     </div><div class="line">    <span class="keyword">unsigned</span> pending_strong_ref:<span class="number">1</span>;</div><div class="line">    <span class="keyword">unsigned</span> has_weak_ref:<span class="number">1</span>;</div><div class="line">    <span class="keyword">unsigned</span> pending_weak_ref:<span class="number">1</span>;</div><div class="line"></div><div class="line">    <span class="comment">// &#x63CF;&#x8FF0;Binder&#x5BF9;&#x8C61;&#x662F;&#x5426;&#x6B63;&#x5728;&#x5904;&#x7406;&#x4E00;&#x4E2A;&#x5F02;&#x6B65;&#x4E8B;&#x52A1;&#x3002;Binder&#x9A71;&#x52A8;&#x7A0B;&#x5E8F;&#x5C06;&#x4E00;&#x4E2A;&#x4E8B;&#x52A1;&#x4FDD;&#x5B58;&#x5728;todo&#x961F;&#x5217;&#x4E2D;</span></div><div class="line">    <span class="comment">// &#x8868;&#x793A;&#x5C06;&#x7531;&#x8BE5;&#x7EBF;&#x7A0B;&#x6765;&#x5904;&#x7406;&#x8BE5;&#x4E8B;&#x52A1;&#x3002;&#x6BCF;&#x4E2A;&#x4E8B;&#x52A1;&#x90FD;&#x5173;&#x8054;&#x7740;&#x4E00;&#x4E2A;Binder&#x5B9E;&#x4F53;&#x5BF9;&#x8C61;&#xFF0C;&#x8981;&#x6C42;&#x4E0E;&#x8BE5;Binder&#x5B9E;</span></div><div class="line">    <span class="comment">// &#x4F53;&#x5BF9;&#x8C61;&#x5BF9;&#x5E94;&#x7684;Service&#x7EC4;&#x4EF6;&#x5728;&#x6307;&#x5B9A;&#x7EBF;&#x7A0B;&#x4E2D;&#x5904;&#x7406;&#x8BE5;&#x4E8B;&#x52A1;&#x3002;&#x7136;&#x800C;&#xFF0C;&#x5F53;Binder&#x9A71;&#x52A8;&#x53D1;&#x73B0;&#x4E00;&#x4E2A;&#x4E8B;&#x52A1;&#x662F;&#x5F02;</span></div><div class="line">    <span class="comment">// &#x6B65;&#x4E8B;&#x52A1;&#x65F6;&#xFF0C;&#x5C31;&#x4F1A;&#x5C06;&#x5B83;&#x4FDD;&#x5B58;&#x5728;&#x76EE;&#x6807;Binder&#x5B9E;&#x4F53;&#x5BF9;&#x8C61;&#x7684;&#x4E00;&#x4E2A;&#x5F02;&#x6B65;&#x4E8B;&#x52A1;&#x961F;&#x5217;&#x4E2D;&#xFF0C;&#x8FD9;&#x4E2A;&#x5F02;&#x6B65;&#x4E8B;&#x52A1;&#x961F;&#x5217;&#x5C31;</span></div><div class="line">    <span class="comment">// &#x662F;&#x7531;&#x6210;&#x5458;&#x53D8;&#x91CF;async_todo&#x6765;&#x63CF;&#x8FF0;&#x7684;&#x3002;&#x5F02;&#x6B65;&#x4E8B;&#x52A1;&#x7684;&#x5B9A;&#x4E49;&#x662F;&#x90A3;&#x4E9B;&#x5355;&#x5411;&#x7684;&#x8FDB;&#x7A0B;&#x95F4;&#x901A;&#x4FE1;&#x8BF7;&#x6C42;&#xFF0C;&#x5373;&#x4E0D;&#x9700;</span></div><div class="line">    <span class="comment">// &#x8981;&#x7B49;&#x5F85;&#x5E94;&#x7B54;&#x7684;&#x8FDB;&#x7A0B;&#x95F4;&#x901A;&#x4FE1;&#x8BF7;&#x6C42;&#xFF0C;&#x4E0E;&#x6B64;&#x76F8;&#x5BF9;&#x7684;&#x662F;&#x540C;&#x6B65;&#x4E8B;&#x52A1;&#x3002;&#x56E0;&#x4E3A;&#x4E0D;&#x9700;&#x8981;&#x7B49;&#x5F85;&#x5E94;&#x7B54;&#xFF0C;Binder&#x9A71;&#x52A8;&#x5C31;</span></div><div class="line">    <span class="comment">// &#x8BA4;&#x4E3A;&#x5F02;&#x6B65;&#x4E8B;&#x52A1;&#x4F18;&#x5148;&#x7EA7;&#x4F4E;&#x4E8E;&#x540C;&#x6B65;&#x4E8B;&#x52A1;&#xFF0C;&#x5177;&#x4F53;&#x8868;&#x73B0;&#x4E3A;&#x5728;&#x540C;&#x4E00;&#x65F6;&#x523B;&#xFF0C;&#x4E00;&#x4E2A;Binder&#x5B9E;&#x4F53;&#x5BF9;&#x8C61;&#x7684;&#x6240;&#x6709;&#x5F02;&#x6B65;</span></div><div class="line">    <span class="comment">// &#x4E8B;&#x52A1;&#x6700;&#x591A;&#x53EA;&#x6709;&#x4E00;&#x4E2A;&#x4F1A;&#x5F97;&#x5230;&#x5904;&#x7406;&#xFF0C;&#x5176;&#x4F59;&#x7684;&#x90FD;&#x7B49;&#x5F85;&#x5728;&#x5F02;&#x6B65;&#x4E8B;&#x52A1;&#x961F;&#x5217;&#x4E2D;&#xFF0C;&#x800C;&#x540C;&#x6B65;&#x4E8B;&#x52A1;&#x65E0;&#x6B64;&#x9650;&#x5236;&#x3002;</span></div><div class="line">    <span class="keyword">unsigned</span> has_async_transaction:<span class="number">1</span>;</div><div class="line"></div><div class="line">    <span class="comment">// &#x63CF;&#x8FF0;Binder&#x5B9E;&#x4F53;&#x5BF9;&#x8C61;&#x662F;&#x5426;&#x53EF;&#x4EE5;&#x63A5;&#x6536;&#x5305;&#x542B;&#x6709;&#x6587;&#x4EF6;&#x63CF;&#x8FF0;&#x7B26;&#x7684;&#x8FDB;&#x7A0B;&#x95F4;&#x901A;&#x4FE1;&#x6570;&#x636E;&#x3002;1&#x8868;&#x793A;&#x53EF;&#x4EE5;&#x63A5;&#x6536;&#xFF0C;0&#x8868;</span></div><div class="line">    <span class="comment">// &#x793A;&#x7981;&#x6B62;&#x63A5;&#x6536;&#x3002;&#x5F53;&#x4E00;&#x4E2A;&#x8FDB;&#x7A0B;&#x5411;&#x53E6;&#x4E00;&#x4E2A;&#x8FDB;&#x7A0B;&#x53D1;&#x9001;&#x7684;&#x6570;&#x636E;&#x4E2D;&#x5305;&#x542B;&#x6709;&#x6587;&#x4EF6;&#x63CF;&#x8FF0;&#x7B26;&#x65F6;&#xFF0C;Binder&#x9A71;&#x52A8;&#x7A0B;&#x5E8F;&#x5C31;</span></div><div class="line">    <span class="comment">// &#x4F1A;&#x81EA;&#x52A8;&#x5728;&#x76EE;&#x6807;&#x8FDB;&#x7A0B;&#x4E2D;&#x6253;&#x5F00;&#x4E00;&#x4E2A;&#x76F8;&#x540C;&#x7684;&#x6587;&#x4EF6;&#x3002;&#x57FA;&#x4E8E;&#x5B89;&#x5168;&#x6027;&#x8003;&#x8651;&#xFF0C;Binder&#x7A0B;&#x5E8F;&#x5C31;&#x8981;&#x901A;&#x8FC7;&#x8BE5;&#x53D8;&#x91CF;&#x9632;&#x6B62;</span></div><div class="line">    <span class="comment">// &#x6E90;&#x8FDB;&#x7A0B;&#x5728;&#x76EE;&#x6807;&#x8FDB;&#x7A0B;&#x4E2D;&#x6253;&#x5F00;&#x6587;&#x4EF6;&#x3002;</span></div><div class="line">    <span class="keyword">unsigned</span> accept_fds:<span class="number">1</span>;</div><div class="line"></div><div class="line">    <span class="comment">// &#x8868;&#x793A;Binder&#x5B9E;&#x4F53;&#x5BF9;&#x8C61;&#x5728;&#x5904;&#x7406;&#x6765;&#x81EA;Client&#x8FDB;&#x7A0B;&#x7684;&#x8BF7;&#x6C42;&#x65F6;&#xFF0C;&#x4ED6;&#x6240;&#x8981;&#x6C42;&#x7684;&#x5904;&#x7406;&#x7EBF;&#x7A0B;&#xFF08;&#x5373;Server&#x8FDB;&#x7A0B;</span></div><div class="line">    <span class="comment">// &#x4E2D;&#x7684;&#x4E00;&#x4E2A;&#x7EBF;&#x7A0B;&#xFF09;&#x5E94;&#x5177;&#x5907;&#x7684;&#x6700;&#x5C0F;&#x7EBF;&#x7A0B;&#x4F18;&#x5148;&#x7EA7;&#x3002;</span></div><div class="line">    <span class="keyword">unsigned</span> min_priority:<span class="number">8</span>;       </div><div class="line">    <span class="keyword">struct</span> list_head async_todo;</div><div class="line">};</div></pre></td></tr></table></figure></p>
<p>&#x63A5;&#x4E0B;&#x6765;&#x7684;binder_new_node(proc, fp-&gt;binder, fp-&gt;cookie)&#x5C06;&#x7533;&#x8BF7;&#x4E00;&#x4E2A;<code>struct binder_node</code>&#xFF0C;&#x5728;&#x521D;&#x59CB;&#x5316;&#x4E2D;&#xFF0C;&#x5C06;&#x8BE5;&#x8282;&#x70B9;&#x6302;&#x5230;proc-&gt;nodes.rb_node&#x4E2D;&#xFF0C;&#x5E76;&#x521D;&#x59CB;&#x5316;&#x90E8;&#x5206;&#x6210;&#x5458;&#xFF0C;&#x6570;&#x636E;&#x7ED3;&#x6784;&#x56FE;&#x5982;&#x4E0B;&#xFF1A;<br><img src="/2016/06/14/2016/0614BinderLearning12/img12.png" alt="&#x5728;case BINDER_TYPE_BINDER&#x548C;case BINDER_TYPE_WEAK_BINDER&#x4E2D;&#x521B;&#x5EFA;&#x7684;struct binder_node"></p>
<h2 id="struct-binder-ref"><a href="#struct-binder-ref" class="headerlink" title="struct binder_ref"></a>struct binder_ref</h2><p>struct binder_ref&#x7528;&#x6765;&#x63CF;&#x8FF0;&#x4E00;&#x4E2A;Binder&#x5F15;&#x7528;&#x5BF9;&#x8C61;&#xFF0C;&#x5F53;&#x5BA2;&#x6237;&#x7AEF;&#x4F7F;&#x7528;Binder&#x5B9E;&#x4F53;&#x65F6;&#xFF0C;&#x5728;&#x5BA2;&#x6237;&#x7AEF;&#x4FDD;&#x5B58;&#x7684;&#x5C31;&#x662F;&#x5BF9;&#x8BE5;&#x5B9E;&#x4F53;&#x7684;&#x5F15;&#x7528;&#xFF0C;&#x8BE5;&#x7ED3;&#x6784;&#x4F53;&#x7528;&#x6765;&#x63CF;&#x8FF0;&#x5F15;&#x7528;&#x5BF9;&#x8C61;&#x5728;&#x5185;&#x6838;&#x4E2D;&#x7684;&#x72B6;&#x6001;&#x3002;kernel/goldfish/drivers/staging/android/binder.c:246<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> binder_ref {</div><div class="line">    <span class="comment">/* Lookups needed: */</span></div><div class="line">    <span class="comment">/*   node + proc =&gt; ref (transaction) */</span></div><div class="line">    <span class="comment">/*   desc + proc =&gt; ref (transaction, inc/dec ref) */</span></div><div class="line">    <span class="comment">/*   node =&gt; refs + procs (proc exit) */</span></div><div class="line">    <span class="keyword">int</span> debug_id;</div><div class="line"></div><div class="line">    <span class="comment">// &#x5BBF;&#x4E3B;&#x8FDB;&#x7A0B;&#x4F7F;&#x7528;&#x4E24;&#x4E2A;&#x7EA2;&#x9ED1;&#x6811;&#x6765;&#x4FDD;&#x5B58;&#x5B83;&#x5185;&#x90E8;&#x6240;&#x6709;Binder&#x5F15;&#x7528;&#x5BF9;&#x8C61;&#xFF0C;&#x5206;&#x522B;&#x4EE5;&#x53E5;&#x67C4;&#x503C;&#x548C;&#x5BF9;&#x5E94;&#x7684;Binder</span></div><div class="line">    <span class="comment">// &#x5B9E;&#x4F53;&#x5BF9;&#x8C61;&#x5730;&#x5740;&#x6765;&#x4F5C;&#x4E3A;&#x5173;&#x952E;&#x5B57;&#x4FDD;&#x5B58;&#x8FD9;&#x4E9B;&#x5F15;&#x7528;&#x5BF9;&#x8C61;&#xFF0C;&#x8FD9;&#x4E24;&#x4E2A;rb_node_xxxx&#x6B63;&#x662F;&#x7EA2;&#x9ED1;&#x6811;&#x4E2D;&#x7684;&#x8282;&#x70B9;</span></div><div class="line">    <span class="keyword">struct</span> rb_node rb_node_desc;    </div><div class="line">    <span class="keyword">struct</span> rb_node rb_node_node;</div><div class="line"></div><div class="line">    <span class="comment">// &#x6BCF;&#x4E2A;Binder&#x5B9E;&#x4F53;&#x5BF9;&#x8C61;&#x90FD;&#x6709;&#x4E00;&#x4E2A;hash&#x8868;&#x4FDD;&#x5B58;&#x5F15;&#x7528;&#x4E86;&#x5B83;&#x7684;Binder&#x5F15;&#x7528;&#x5BF9;&#x8C61;&#xFF0C;&#x8FD9;&#x4E9B;&#x5F15;&#x7528;&#x5BF9;&#x8C61;&#x7684;&#x6210;&#x5458;</span></div><div class="line">    <span class="comment">// node_entry&#x5C31;&#x662F;&#x8BE5;hash&#x8868;&#x7684;&#x8282;&#x70B9;</span></div><div class="line">    <span class="keyword">struct</span> hlist_node node_entry;   </div><div class="line">    <span class="keyword">struct</span> binder_proc *proc;   <span class="comment">// &#x5BBF;&#x4E3B;&#x8FDB;&#x7A0B;</span></div><div class="line">    <span class="keyword">struct</span> binder_node *node;   <span class="comment">// &#x63CF;&#x8FF0;Binder&#x5F15;&#x7528;&#x5BF9;&#x8C61;&#x6240;&#x5F15;&#x7528;&#x7684;Binder&#x5B9E;&#x4F53;&#x5BF9;&#x8C61;</span></div><div class="line"></div><div class="line">    <span class="comment">// &#x63CF;&#x8FF0;Binder&#x5F15;&#x7528;&#x5BF9;&#x8C61;&#x7684;&#x53E5;&#x67C4;&#x503C;&#xFF0C;&#x9A71;&#x52A8;&#x901A;&#x8FC7;&#x8BE5;&#x53E5;&#x67C4;&#x627E;&#x5230;&#x5BF9;&#x5E94;&#x7684;Binder&#x5F15;&#x7528;&#x5BF9;&#x8C61;&#xFF0C;&#x7136;&#x540E;&#x518D;&#x6839;&#x636E;&#x8BE5;</span></div><div class="line">    <span class="comment">// Binder&#x5F15;&#x7528;&#x5BF9;&#x8C61;&#x7684;&#x6210;&#x5458;node&#x627E;&#x5230;&#x5BF9;&#x5E94;&#x7684;Binder&#x5B9E;&#x4F53;&#x5BF9;&#x8C61;&#xFF0C;&#x7136;&#x540E;&#x5C31;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x8BE5;&#x5B9E;&#x4F53;&#x5BF9;&#x8C61;&#x627E;&#x5230;&#x8981;</span></div><div class="line">    <span class="comment">// &#x8BBF;&#x95EE;&#x7684;Service&#x7EC4;&#x4EF6;&#x4E86;&#x3002;&#x4E00;&#x4E2A;Binder&#x5F15;&#x7528;&#x5BF9;&#x8C61;&#x7684;&#x53E5;&#x67C4;&#x503C;&#x4EC5;&#x5728;&#x8FDB;&#x7A0B;&#x8303;&#x56F4;&#x5185;&#x552F;&#x4E00;&#xFF0C;&#x56E0;&#x6B64;&#x5728;&#x4E24;&#x4E2A;&#x4E0D;&#x540C;</span></div><div class="line">    <span class="comment">// &#x8FDB;&#x7A0B;&#x4E2D;&#xFF0C;&#x540C;&#x4E00;&#x4E2A;&#x53E5;&#x67C4;&#x53EF;&#x80FD;&#x4EE3;&#x8868;&#x4E0D;&#x540C;&#x7684;Service&#x7EC4;&#x4EF6;</span></div><div class="line">    <span class="keyword">uint32_t</span> desc;</div><div class="line"></div><div class="line">    <span class="keyword">int</span> strong;                 <span class="comment">// &#x63CF;&#x8FF0;Binder&#x5F15;&#x7528;&#x5BF9;&#x8C61;&#x7684;&#x5F3A;/&#x5F31;&#x5F15;&#x7528;&#x8BA1;&#x6570;</span></div><div class="line">    <span class="keyword">int</span> weak;</div><div class="line"></div><div class="line">    <span class="comment">// &#x6307;&#x5411;&#x4E00;&#x4E2A;Service&#x7EC4;&#x4EF6;&#x7684;&#x6B7B;&#x4EA1;&#x63A5;&#x6536;&#x901A;&#x77E5;&#x3002;&#x5F53;Client&#x8FDB;&#x7A0B;&#x5411;Binder&#x9A71;&#x52A8;&#x7A0B;&#x5E8F;&#x6CE8;&#x518C;&#x4E00;&#x4E2A;&#x5B83;&#x6240;&#x5F15;&#x7528;</span></div><div class="line">    <span class="comment">// &#x7684;Service&#x7EC4;&#x4EF6;&#x6B7B;&#x4EA1;&#x63A5;&#x6536;&#x901A;&#x77E5;&#x65F6;&#xFF0C;Binder&#x9A71;&#x52A8;&#x7A0B;&#x5E8F;&#x4F1A;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;binder_ref_death&#x7ED3;&#x6784;&#x4F53;&#xFF0C;&#x7136;</span></div><div class="line">    <span class="comment">// &#x540E;&#x4FDD;&#x5B58;&#x5728;&#x8BE5;&#x6210;&#x5458;&#x53D8;&#x91CF;death&#x4E2D;</span></div><div class="line">    <span class="keyword">struct</span> binder_ref_death *death; </div><div class="line">};</div></pre></td></tr></table></figure></p>
<p>&#x63A5;&#x4E0B;&#x6765;&#x770B;binder_get_ref_for_node(target_proc, node)&#x3002;&#x9700;&#x8981;&#x6CE8;&#x610F;&#xFF0C;&#x524D;&#x9762;&#x521B;&#x5EFA;binder_node&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x662F;&#x4E3A;proc&#x521B;&#x5EFA;&#x7684;&#xFF0C;proc&#x662F;&#x5728;&#x8C03;&#x7528;binder_open(&#x2026;)&#x65F6;&#x521B;&#x5EFA;&#xFF0C;&#x7528;&#x6765;&#x63CF;&#x8FF0;&#x201C;&#x4F7F;&#x7528;&#xFF08;&#x6253;&#x5F00;&#xFF09;&#x8BE5;binder&#x7684;&#x8FDB;&#x7A0B;&#x201D;&#xFF0C;proc&#x5C31;&#x85CF;&#x5728;binder&#x6587;&#x4EF6;&#x7684;&#x6587;&#x4EF6;&#x63CF;&#x8FF0;&#x7B26;&#x7684;&#x79C1;&#x6709;&#x6570;&#x636E;&#x4E2D;&#xFF1B;&#x800C;&#x6B64;&#x5904;&#xFF08;&#x7B2C;150&#x884C;&#xFF09;&#x53C2;&#x6570;&#x4F7F;&#x7528;&#x7684;&#x662F;target_proc&#xFF0C;&#x5B83;&#x8868;&#x793A;&#x5F53;&#x524D;&#x7684;binder&#x8BF7;&#x6C42;&#x53D1;&#x5411;&#x7684;&#x76EE;&#x6807;&#x8FDB;&#x7A0B;&#xFF0C;&#x5728;&#x672C;&#x4E0A;&#x4E0B;&#x6587;&#x4E2D;&#x5C31;&#x662F;handle&#x4E3A;0&#x7684;service manager&#xFF0C;&#x5373;binder_context_mgr_node&#x3002;<br>kernel/goldfish/drivers/staging/android/binder.c:1107<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">struct</span> binder_ref *<span class="title">binder_get_ref_for_node</span><span class="params">(<span class="keyword">struct</span> binder_proc *proc,</span></span></div><div class="line">                          <span class="keyword">struct</span> binder_node *node)</div><div class="line">{</div><div class="line">    <span class="keyword">struct</span> rb_node *n;</div><div class="line">    <span class="keyword">struct</span> rb_node **p = &amp;proc-&gt;refs_by_node.rb_node;</div><div class="line">    <span class="keyword">struct</span> rb_node *parent = <span class="literal">NULL</span>;</div><div class="line">    <span class="keyword">struct</span> binder_ref *ref, *new_ref;</div><div class="line">    <span class="comment">// &#x5728;target_proc&#x4E2D;&#x67E5;&#x627E;node&#xFF0C;&#x5982;&#x679C;&#x627E;&#x4E0D;&#x5230;&#x5C31;&#x521B;&#x5EFA;</span></div><div class="line">    <span class="keyword">while</span> (*p) {</div><div class="line">        parent = *p;</div><div class="line">        ref = rb_entry(parent, <span class="keyword">struct</span> binder_ref, rb_node_node);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (node &lt; ref-&gt;node)</div><div class="line">            p = &amp;(*p)-&gt;rb_left;</div><div class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (node &gt; ref-&gt;node)</div><div class="line">            p = &amp;(*p)-&gt;rb_right;</div><div class="line">        <span class="keyword">else</span></div><div class="line">            <span class="keyword">return</span> ref;</div><div class="line">    }</div><div class="line">    new_ref = kzalloc(<span class="keyword">sizeof</span>(*ref), GFP_KERNEL);</div><div class="line">    ... ...</div><div class="line">    binder_stats_created(BINDER_STAT_REF);</div><div class="line">    new_ref-&gt;debug_id = ++binder_last_id;</div><div class="line">    new_ref-&gt;proc = proc;</div><div class="line">    new_ref-&gt;node = node;</div><div class="line">    rb_link_node(&amp;new_ref-&gt;rb_node_node, parent, p);</div><div class="line">    rb_insert_color(&amp;new_ref-&gt;rb_node_node, &amp;proc-&gt;refs_by_node);</div><div class="line"></div><div class="line">    <span class="comment">// &#x904D;&#x5386;target_proc&#x7684;binder_ref&#xFF0C;&#x627E;&#x5230;&#x6700;&#x5927;&#x7684;desc&#xFF0C;&#x52A0;1&#x540E;&#x8D4B;&#x7ED9;new_ref-&gt;desc</span></div><div class="line">    new_ref-&gt;desc = (node == binder_context_mgr_node) ? <span class="number">0</span> : <span class="number">1</span>;</div><div class="line">    <span class="keyword">for</span> (n = rb_first(&amp;proc-&gt;refs_by_desc); n != <span class="literal">NULL</span>; n = rb_next(n)) {</div><div class="line">        ref = rb_entry(n, <span class="keyword">struct</span> binder_ref, rb_node_desc);</div><div class="line">        <span class="keyword">if</span> (ref-&gt;desc &gt; new_ref-&gt;desc)</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        new_ref-&gt;desc = ref-&gt;desc + <span class="number">1</span>;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">// &#x5C06;new_ref&#x63D2;&#x5165;&#x5230;target_proc-&gt;refs_by_desc.rb_node&#x4E2D;</span></div><div class="line">    p = &amp;proc-&gt;refs_by_desc.rb_node;</div><div class="line">    <span class="keyword">while</span> (*p) {</div><div class="line">        parent = *p;</div><div class="line">        ref = rb_entry(parent, <span class="keyword">struct</span> binder_ref, rb_node_desc);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (new_ref-&gt;desc &lt; ref-&gt;desc)</div><div class="line">            p = &amp;(*p)-&gt;rb_left;</div><div class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (new_ref-&gt;desc &gt; ref-&gt;desc)</div><div class="line">            p = &amp;(*p)-&gt;rb_right;</div><div class="line">        <span class="keyword">else</span></div><div class="line">            BUG();</div><div class="line">    }</div><div class="line">    rb_link_node(&amp;new_ref-&gt;rb_node_desc, parent, p);</div><div class="line">    rb_insert_color(&amp;new_ref-&gt;rb_node_desc, &amp;proc-&gt;refs_by_desc);</div><div class="line">    <span class="keyword">if</span> (node) {</div><div class="line">        hlist_add_head(&amp;new_ref-&gt;node_entry, &amp;node-&gt;refs);</div><div class="line">        ... ...</div><div class="line">    } </div><div class="line">    ... ...</div><div class="line">    <span class="keyword">return</span> new_ref;</div><div class="line">}</div></pre></td></tr></table></figure></p>
<p>&#x4E8E;&#x662F;&#xFF0C;&#x5728;binder_transaction(&#x2026;)&#x51FD;&#x6570;&#x7B2C;114&#x884C;&#x5B8C;&#x6210;&#x8C03;&#x7528;<code>binder_get_ref_for_node(target_proc, node)</code>&#x4E4B;&#x540E;&#xFF0C;&#x6570;&#x636E;&#x7ED3;&#x6784;&#x56FE;&#x4E3A;&#xFF1A;<br><img src="/2016/06/14/2016/0614BinderLearning12/img13.png" alt="&#x5728;binder_transaction(...)&#x51FD;&#x6570;&#x4E2D;&#x4E3A;target_proc&#x521B;&#x5EFA;&#x5B8C;binder_ref&#x4E4B;&#x540E;&#x7684;&#x6570;&#x636E;&#x7ED3;&#x6784;"></p>
<p>&#x63A5;&#x4E0B;&#x6765;&#x5728;&#x51FD;&#x6570;binder_transaction(&#x2026;)&#x4E2D;&#x8FD8;&#x6709;&#x51E0;&#x4E2A;&#x5173;&#x952E;&#x64CD;&#x4F5C;&#xFF0C;&#x89C1;&#x7B2C;116&#x884C;&#xFF0C;&#x5982;&#x679C;fp-&gt;type&#x4E3A;BINDER_TYPE_BINDER&#xFF0C;&#x5C31;&#x6539;&#x4E3A;BINDER_TYPE_HANDLE&#xFF0C;&#x7136;&#x540E;&#x628A;fp-&gt;handle&#x6539;&#x4E3A;ref-&gt;desc&#xFF0C;&#x63A5;&#x4E0B;&#x6765;&#x7684;binder_ref_ref(ref, fp-&gt;type==BINDER_TYPE_HANDLE, &amp;thread-&gt;todo)&#x5B9A;&#x4E49;&#x5728;kernel/goldfish/drivers/staging/android/binder.c:1200<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">binder_inc_ref</span><span class="params">(<span class="keyword">struct</span> binder_ref *ref, <span class="keyword">int</span> strong,</span></span></div><div class="line">              <span class="keyword">struct</span> list_head *target_list)</div><div class="line">{   <span class="comment">// strong = (fp-&gt;type==BINDER_TYPE_HANDLE)&#x5373;&#x4E3A;1</span></div><div class="line">    <span class="comment">// target_list = &amp;thread-&gt;todo</span></div><div class="line">    <span class="keyword">int</span> ret;</div><div class="line">    <span class="keyword">if</span> (strong) {</div><div class="line">        <span class="keyword">if</span> (ref-&gt;strong == <span class="number">0</span>) {</div><div class="line">            <span class="comment">// ref-&gt;node-&gt;internal_strong_ref++&#xFF0C;&#x6210;&#x529F;&#x8FD4;&#x56DE;0</span></div><div class="line">            ret = binder_inc_node(ref-&gt;node, <span class="number">1</span>, <span class="number">1</span>, target_list);</div><div class="line">            <span class="keyword">if</span> (ret)</div><div class="line">                <span class="keyword">return</span> ret;</div><div class="line">        }</div><div class="line">        ref-&gt;strong++;</div><div class="line">    } <span class="keyword">else</span> {</div><div class="line">        <span class="keyword">if</span> (ref-&gt;weak == <span class="number">0</span>) {</div><div class="line">            ret = binder_inc_node(ref-&gt;node, <span class="number">0</span>, <span class="number">1</span>, target_list);</div><div class="line">            <span class="keyword">if</span> (ret)</div><div class="line">                <span class="keyword">return</span> ret;</div><div class="line">        }</div><div class="line">        ref-&gt;weak++;</div><div class="line">    }</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">}</div></pre></td></tr></table></figure></p>
<p>&#x63A5;&#x4E0B;&#x6765;&#x8DF3;&#x51FA;case&#x540E;&#x8FD8;&#x6709;&#x5BF9;t&#x7684;&#x6210;&#x5458;need_reply&#x3001;from_parent&#x3001;t-&gt;work.type&#x7684;&#x5904;&#x7406;&#xFF0C;&#x5E76;&#x5C06;t&#x63D2;&#x5165;&#x5230;target_list&#x5373;target_proc&#x6216;target_thread&#x7684;todo&#x961F;&#x5217;&#x4E2D;&#xFF0C;&#x5C14;&#x540E;&#x8FD4;&#x56DE;&#x3002;&#x6B64;&#x65F6;&#x7684;&#x6570;&#x636E;&#x7ED3;&#x6784;&#x56FE;&#x4E3A;&#xFF1A;<br><img src="/2016/06/14/2016/0614BinderLearning12/img14.png" alt="binder_transaction(...)&#x5B8C;&#x6210;&#x65F6;&#x7684;&#x6570;&#x636E;&#x7ED3;&#x6784;"></p>
<p>&#x5230;&#x6B64;&#x4E3A;&#x6B62;&#xFF0C;&#x7EC8;&#x4E8E;&#x5B8C;&#x6210;&#x4E86;binder_transaction(&#x2026;)&#x7684;&#x5206;&#x6790;&#xFF0C;&#x77E5;&#x9053;&#x600E;&#x4E48;&#x56DE;&#x4E8B;&#xFF0C;&#x4F46;&#x5FC3;&#x91CC;&#x6709;&#x5F88;&#x591A;&#x4E2A;&#x201C;&#x4E3A;&#x4EC0;&#x4E48;&#x201D;&#x3002;&#x800C;&#x4E14;&#x628A;&#x524D;&#x9762;&#x7684;&#x5B66;&#x4E60;&#x7B14;&#x8BB0;&#x4E32;&#x8054;&#x8D77;&#x6765;&#xFF0C;&#x9690;&#x7EA6;&#x89C9;&#x5F97;&#x80FD;&#x611F;&#x5E94;&#x5230;&#x4E00;&#x4E9B;&#x66D9;&#x5149;&#x4E86;&#xFF0C;&#x672C;&#x8282;&#x7684;&#x7BC7;&#x5E45;&#x592A;&#x957F;&#x4E86;&#xFF0C;&#x8FD9;&#x4E9B;&#x66D9;&#x5149;&#x7559;&#x5F85;&#x4E0B;&#x4E00;&#x8282;&#x4E00;&#x8D77;&#x9886;&#x7565;&#x5427;&#x3002;</p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Binder学习笔记/" rel="tag">#Binder学习笔记</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2016/06/10/2016/0610BinderLearning11/" rel="next" title="Binder学习笔记（十一）—— 智能指针">
                <i class="fa fa-chevron-left"></i> Binder学习笔记（十一）—— 智能指针
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2016/07/09/2016/0709BinderLearning13/" rel="prev" title="Binder学习笔记（十三）—— 小结">
                Binder学习笔记（十三）—— 小结 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div class="ds-thread" data-thread-key="2016/06/14/2016/0614BinderLearning12/"
           data-title="Binder学习笔记（十二）—— binder_transaction(...)都干了什么？" data-url="http://palanceli.github.io/2016/06/14/2016/0614BinderLearning12/">
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="https://avatars0.githubusercontent.com/u/13184524"
               alt="Palance Li" />
          <p class="site-author-name" itemprop="name">Palance Li</p>
          <p class="site-description motion-element" itemprop="description">学习，重生</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">138</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">18</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">50</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/palanceli" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://blog.csdn.net/zchongr" target="_blank" title="我的CSDN">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  我的CSDN
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://www.cnblogs.com/palance/" target="_blank" title="我的博客园">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  我的博客园
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://www.jianshu.com/" target="_blank" title="我的简书">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  我的简书
                </a>
              </span>
            
          
        </div>

        
        

        
        

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#binder-open-…-都干了什么？"><span class="nav-text">binder_open(…)都干了什么？</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#struct-binder-proc"><span class="nav-text">struct binder_proc</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#binder-proc中的链表"><span class="nav-text">binder_proc中的链表</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#INIT-LIST-HEAD-amp-proc-gt-todo"><span class="nav-text">INIT_LIST_HEAD(&proc->todo)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#init-waitqueue-head-amp-proc-gt-wait"><span class="nav-text">init_waitqueue_head(&proc->wait)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#hlist-add-head-amp-proc-gt-proc-node-amp-binder-procs"><span class="nav-text">hlist_add_head(&proc->proc_node, &binder_procs)</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#binder-mmap-…-都干了什么？"><span class="nav-text">binder_mmap(…)都干了什么？</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#binder-update-page-range-…-做了什么"><span class="nav-text">binder_update_page_range(…)做了什么</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#struct-binder-buffer"><span class="nav-text">struct binder_buffer</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#list-add-amp-buffer-gt-entry-amp-proc-gt-buffers"><span class="nav-text">list_add(&buffer->entry, &proc->buffers)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#函数binder-insert-free-buffer-…"><span class="nav-text">函数binder_insert_free_buffer(…)</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#从服务端addService触发的binder-transaction"><span class="nav-text">从服务端addService触发的binder_transaction(...)</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#struct-binder-transaction"><span class="nav-text">struct binder_transaction</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#struct-binder-work"><span class="nav-text">struct binder_work</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#struct-binder-node"><span class="nav-text">struct binder_node</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#struct-binder-ref"><span class="nav-text">struct binder_ref</span></a></li></ol></li></ol></div>
            
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Palance Li</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.0.1"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.0.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.0.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"palanceli"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    <script src="/lib/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  






  
  

  

  

  

</body>
</html>
